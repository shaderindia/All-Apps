<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fanuc Helical Interpolation Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .input-group { position: relative; }
    .input-unit { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 0.875rem; }
    .tab-btn { transition: all 0.15s ease-in-out; }
    .tab-btn.active { background-color: #4f46e5; color: white; }
    .tab-btn:not(.active) { background-color: #374151; color: #d1d5db; }
    input:disabled, select:disabled { background-color: #374151; color: #6b7280; cursor: not-allowed; border-color: #4b5563; }
    pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

  <div class="w-full max-w-2xl bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">

    <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-indigo-400">Fanuc Helical Interpolation Generator</h1>

    <div class="flex justify-center mb-6 bg-gray-700 rounded-lg p-1">
      <button id="id-interpolation-tab" class="tab-btn w-1/2 py-2 rounded-md text-sm font-semibold active">ID Helical Milling</button>
      <button id="od-interpolation-tab" class="tab-btn w-1/2 py-2 rounded-md text-sm font-semibold">OD Helical Milling</button>
    </div>

    <div id="interpolation-inputs" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-lg">
        <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Workpiece & Tool Setup</h3></div>

        <div>
          <label for="plane-select" class="block text-sm font-medium">Work Plane</label>
          <select id="plane-select" class="w-full bg-gray-700 rounded-lg p-3 mt-1">
            <option value="G17">G17 (X-Y)</option>
            <option value="G18">G18 (X-Z)</option>
            <option value="G19">G19 (Y-Z)</option>
          </select>
        </div>

        <div>
          <label for="cutter-diameter" class="block text-sm font-medium">Cutter Diameter</label>
          <div class="input-group">
            <input type="number" id="cutter-diameter" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 10">
            <span class="input-unit">mm</span>
          </div>
        </div>

        <div>
          <label for="program-number" class="block text-sm font-medium">Program Number</label>
          <div class="input-group">
            <input type="number" id="program-number" value="1001" class="w-full bg-gray-700 rounded-lg p-3">
            <span class="input-unit">O####</span>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-700 rounded-lg">
        <div class="md:col-span-2"><h3 class="text-lg font-semibold text-gray-300">Feature Geometry</h3></div>
        <div class="md:col-span-2 grid grid-cols-2 gap-4">
          <div>
            <label id="center1-label" for="center1" class="block text-sm font-medium">Center X</label>
            <div class="input-group"><input type="number" id="center1" value="0" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
          </div>
          <div>
            <label id="center2-label" for="center2" class="block text-sm font-medium">Center Y</label>
            <div class="input-group"><input type="number" id="center2" value="0" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
          </div>
        </div>

        <div>
          <label id="final-diameter-label" for="final-diameter" class="block text-sm font-medium">Final ID Diameter</label>
          <div class="input-group"><input type="number" id="final-diameter" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 50"><span class="input-unit">mm</span></div>
        </div>

        <div class="flex items-end">
          <div class="flex items-center h-full pb-1">
            <input type="checkbox" id="use-diameter-macro" class="h-5 w-5 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600">
            <label for="use-diameter-macro" class="ml-2 text-sm font-medium">Use Macro for Diameter (#500)</label>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-lg">
        <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Machining Parameters</h3></div>

        <div>
          <label id="final-depth-label" for="final-depth" class="block text-sm font-medium">Final Depth (Z)</label>
          <div class="input-group"><input type="number" id="final-depth" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., -15"><span class="input-unit">mm</span></div>
        </div>

        <div>
          <label for="pitch" class="block text-sm font-medium">Pitch (Depth/Rev)</label>
          <div class="input-group"><input type="number" id="pitch" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 1.5"><span class="input-unit">mm</span></div>
        </div>

        <div>
          <label for="safety-distance" class="block text-sm font-medium">Z Safety Distance</label>
          <div class="input-group"><input type="number" id="safety-distance" value="5" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
        </div>

        <div>
          <label id="xy-safety-dist-label" for="xy-safety-distance" class="block text-sm font-medium">XY Clearance</label>
          <div class="input-group"><input type="number" id="xy-safety-distance" value="2" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
        </div>

        <div>
          <label for="spindle-speed" class="block text-sm font-medium">Spindle Speed</label>
          <div class="input-group"><input type="number" id="spindle-speed" value="3000" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">RPM</span></div>
        </div>

        <div>
          <label for="feed-rate" class="block text-sm font-medium">Feed Rate</label>
          <div class="input-group"><input type="number" id="feed-rate" value="500" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm/min</span></div>
        </div>

        <div class="md:col-span-3 grid grid-cols-2 gap-4">
          <div>
            <label for="tool-offset-d" class="block text-sm font-medium">Tool Offset (D & H)</label>
            <input type="number" id="tool-offset-d" value="1" class="w-full bg-gray-700 rounded-lg p-3">
          </div>

          <div>
            <label for="milling-type" class="block text-sm font-medium">Milling Type</label>
            <select id="milling-type" class="w-full bg-gray-700 rounded-lg p-3 mt-1">
              <option value="G41">Climb (G41)</option>
              <option value="G42">Conventional (G42)</option>
            </select>
          </div>
        </div>

        <div class="md:col-span-3 flex items-center pt-2">
          <input type="checkbox" id="add-finish-pass" class="h-5 w-5 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600" checked>
          <label for="add-finish-pass" class="ml-2 text-sm font-medium">Add Finish Pass at Final Depth</label>
        </div>
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-4 mt-6">
      <button id="generate-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Generate G-Code</button>
      <button id="download-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition hidden">Download .NC</button>
    </div>

    <div id="results-section" class="mt-8 pt-6 border-t border-gray-700 hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-semibold text-indigo-400">Generated G-Code</h2>
        <button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Copy Code</button>
      </div>
      <pre id="gcode-output" class="bg-gray-900 text-white p-4 rounded-lg text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
    </div>

    <div id="error-message" class="mt-4 text-center text-red-400 font-medium hidden"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // UI elements
      const idTab = document.getElementById('id-interpolation-tab');
      const odTab = document.getElementById('od-interpolation-tab');
      const planeSelect = document.getElementById('plane-select');
      const generateBtn = document.getElementById('generate-btn');
      const downloadBtn = document.getElementById('download-btn');
      const copyBtn = document.getElementById('copy-btn');
      const resultsSection = document.getElementById('results-section');
      const gcodeOutput = document.getElementById('gcode-output');
      const errorMessage = document.getElementById('error-message');

      let currentOperation = 'id-interpolation';

      idTab.addEventListener('click', () => switchOp('id-interpolation'));
      odTab.addEventListener('click', () => switchOp('od-interpolation'));
      planeSelect.addEventListener('change', updateLabels);
      generateBtn.addEventListener('click', generateGCode);
      copyBtn.addEventListener('click', copyToClipboard);
      downloadBtn.addEventListener('click', downloadGCode);

      function switchOp(op) {
        currentOperation = op;
        idTab.classList.toggle('active', op === 'id-interpolation');
        odTab.classList.toggle('active', op === 'od-interpolation');
        document.getElementById('xy-safety-distance').disabled = (op !== 'od-interpolation');
        updateLabels();
        resultsSection.classList.add('hidden');
        hideError();
      }

      function updateLabels() {
        const plane = planeSelect.value;
        const axes = getAxes(plane);
        document.getElementById('center1-label').textContent = `Center ${axes.p1}`;
        document.getElementById('center2-label').textContent = `Center ${axes.p2}`;
        document.getElementById('final-diameter-label').textContent = currentOperation === 'id-interpolation' ? `Final ID Diameter` : `Final OD Diameter`;
        document.getElementById('final-depth-label').textContent = `Final Depth (${axes.depth})`;
        document.getElementById('xy-safety-dist-label').textContent = `${axes.p1}/${axes.p2} Clearance (OD)`;
      }

      function getAxes(plane) {
        if (plane === 'G18') return { p1: 'X', p2: 'Z', depth: 'Y', arc1: 'I', arc2: 'K' };
        if (plane === 'G19') return { p1: 'Y', p2: 'Z', depth: 'X', arc1: 'J', arc2: 'K' };
        return { p1: 'X', p2: 'Y', depth: 'Z', arc1: 'I', arc2: 'J' };
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.classList.remove('hidden');
        resultsSection.classList.add('hidden');
      }
      function hideError() {
        errorMessage.classList.add('hidden');
      }

      function getInputs() {
        const data = {
          opType: currentOperation,
          plane: planeSelect.value,
          progNum: parseInt(document.getElementById('program-number').value, 10),
          cutterDia: parseFloat(document.getElementById('cutter-diameter').value),
          center1: parseFloat(document.getElementById('center1').value),
          center2: parseFloat(document.getElementById('center2').value),
          finalDia: parseFloat(document.getElementById('final-diameter').value),
          finalDepth: parseFloat(document.getElementById('final-depth').value),
          pitch: parseFloat(document.getElementById('pitch').value),
          rpm: parseInt(document.getElementById('spindle-speed').value, 10),
          feed: parseFloat(document.getElementById('feed-rate').value),
          safetyDist: parseFloat(document.getElementById('safety-distance').value),
          xySafetyDist: parseFloat(document.getElementById('xy-safety-distance').value),
          useDiaMacro: document.getElementById('use-diameter-macro').checked,
          addFinishPass: document.getElementById('add-finish-pass').checked,
          toolOffset: parseInt(document.getElementById('tool-offset-d').value, 10),
          millingType: document.getElementById('milling-type').value
        };

        // Basic validation
        const numericKeys = ['progNum','cutterDia','center1','center2','finalDia','finalDepth','pitch','rpm','feed','safetyDist','xySafetyDist','toolOffset'];
        for (const k of numericKeys) {
          if (Number.isNaN(data[k]) || data[k] === null) throw new Error(`Invalid input: ${k} must be a number.`);
        }
        if (data.cutterDia <= 0 || data.finalDia <= 0) throw new Error('Cutter and final diameters must be positive.');
        if (data.pitch <= 0) throw new Error('Pitch must be positive.');
        if (data.opType === 'id-interpolation' && data.cutterDia >= data.finalDia) throw new Error('For ID milling, cutter diameter must be smaller than final diameter.');
        // Normalize depths: if user entered positive value for depth, convert to negative cut
        if (data.finalDepth > 0) data.finalDepth = -data.finalDepth;
        if (data.pitch < 0) data.pitch = Math.abs(data.pitch);
        return data;
      }

     -      // Returns arc vector string (ex: "I-25.000 J0.000")
-      function getArcVectors(axes, radius, mode /* 'id' or 'od' */, millingType, useMacro) {
-        // radius = numeric or string (if macro)
-        const sign = millingType === 'G41' ? 1 : -1;
-        let v1 = 0, v2 = 0;
-
-        if (mode === 'id') {
-          // ID: start at +p2 for G41 (climb) or -p2 for G42
-          // vector to center along p2 is negative of start coordinate
-          v2 = -sign * parseFloat(radius);
-        } else {
-          // OD: start at -p1 for G41 (climb) or +p1 for G42
-          // vector to center along p1 is +sign * radius
-          v1 = sign * parseFloat(radius);
-        }
-
-        // If user requested macros, return macro expressions instead of numeric
-        if (useMacro) {
-          // radius is passed as a string like "#503"
-          let s1 = '0', s2 = '0';
-          if (v1 !== 0) s1 = (v1 < 0 ? '-' : '') + radius;
-          if (v2 !== 0) s2 = (v2 < 0 ? '-' : '') + radius;
-          return `${axes.arc1}${s1} ${axes.arc2}${s2}`;
-        } else {
-          return `${axes.arc1}${v1.toFixed(3)} ${axes.arc2}${v2.toFixed(3)}`;
-        }
-      }
+      // Returns arc vector string (e.g., "I-25.000 J0.000")
+      // Rule enforced: the I/J(K) sign is the OPPOSITE of the engage direction sign.
+      // Engage axis = p2 for ID; p1 for OD.
+      // Engage sign:  ID -> (G41:+ , G42:-)   OD -> (G41:- , G42:+)
+      function getArcVectors(axes, radius, mode /* 'id' or 'od' */, millingType, useMacro) {
+        // Determine engage direction sign (+1 or -1)
+        const engageSign = (mode === 'id')
+          ? (millingType === 'G41' ? +1 : -1)  // ID: G41 engages +p2, G42 engages -p2
+          : (millingType === 'G41' ? -1 : +1); // OD: G41 engages -p1, G42 engages +p1
+
+        // Arc-center vector must be opposite sign of engage
+        const arcSign = -engageSign;
+
+        // radius can be numeric or macro string (e.g., "#503")
+        if (mode === 'id') {
+          // Offset along p2 (J in G17, K in G18/G19 mapping via axes.arc2)
+          if (useMacro) {
+            const s = arcSign < 0 ? '-' : '';
+            return `${axes.arc1}0 ${axes.arc2}${s}${radius}`;
+          } else {
+            const v2 = arcSign * parseFloat(radius);
+            return `${axes.arc1}0.000 ${axes.arc2}${v2.toFixed(3)}`;
+          }
+        } else {
+          // OD: offset along p1 (I in G17, I/K mapped via axes.arc1)
+          if (useMacro) {
+            const s = arcSign < 0 ? '-' : '';
+            return `${axes.arc1}${s}${radius} ${axes.arc2}0`;
+          } else {
+            const v1 = arcSign * parseFloat(radius);
+            return `${axes.arc1}${v1.toFixed(3)} ${axes.arc2}0.000`;
+          }
+        }
+      }

      function buildProgram(inputs) {
        const axes = getAxes(inputs.plane);
        const sign = inputs.millingType === 'G41' ? 1 : -1;
        const cutterRadius = (inputs.cutterDia / 2);
        const finalRadius = (inputs.finalDia / 2);

        // Program name & header
        const progNumStr = `O${inputs.progNum}`;
        const opName = (inputs.opType === 'id-interpolation') ? 'ID HELICAL INTERPOLATION' : 'OD HELICAL INTERPOLATION';

        // Which circular command to use
        // For ID: G03 for G41 (climb) else G02
        // For OD: G02 for G41 (climb) else G03
        const circleCmd = (inputs.opType === 'id-interpolation') ? (inputs.millingType === 'G41' ? 'G03' : 'G02') : (inputs.millingType === 'G41' ? 'G02' : 'G03');

        // Arc vector string. If macros are used, finalRadius and cutterRadius are macros later.
        const finalRadiusStr = inputs.useDiaMacro ? '#503' : finalRadius.toFixed(3);
        const cutterRadiusStr = inputs.useDiaMacro ? '#502' : cutterRadius.toFixed(3);

        const arcVectorString = getArcVectors(axes, finalRadiusStr, inputs.opType === 'id-interpolation' ? 'id' : 'od', inputs.millingType, inputs.useDiaMacro);

        // Calculated entry/exit points depend on op type and compensation sign
        let engagePoint, preEngagePoint, safePoint; // strings like "X12.000 Y0.000"
        if (inputs.useDiaMacro) {
          // Using macros: #100 = center p1, #101 = center p2, #503 final radius, #502 cutter radius, #505 xy clearance
          if (inputs.opType === 'id-interpolation') {
            // ID engage along p2
            engagePoint = `${axes.p2}[#101${sign>0?'+':'-'}#503]`; // if sign positive, +, else -
            preEngagePoint = `${axes.p2}[#101${sign>0?'+':'-'}#503${sign>0?'-':'+'}#502]`;
            safePoint = `${axes.p1}#100 ${axes.p2}[#101]`; // safe XY uses both centers (simple)
          } else {
            // OD engage along p1
            safePoint = `${axes.p1}[#100${sign>0?'-':'+'}#503${sign>0?'-':'+'}#502${sign>0?'-':'+'}#505] ${axes.p2}#101`;
            preEngagePoint = `${axes.p1}[#100${sign>0?'-':'+'}#503${sign>0?'-':'+'}#502]`;
            engagePoint = `${axes.p1}[#100${sign>0?'-':'+'}#503]`;
          }
        } else {
          if (inputs.opType === 'id-interpolation') {
            // engage on p2 at center2 + sign*finalRadius (G41 uses +p2 start)
            const engageP2 = (inputs.center2 + (sign * finalRadius)).toFixed(3);
            engagePoint = `${axes.p2}${engageP2}`;
            preEngagePoint = `${axes.p2}${(inputs.center2 + (sign * finalRadius) - (sign * cutterRadius)).toFixed(3)}`;
            safePoint = `${axes.p1}${inputs.center1.toFixed(3)} ${axes.p2}${inputs.center2.toFixed(3)}`;
          } else {
            // OD: approach from outside along p1
            const safeP1 = (inputs.center1 - (sign * finalRadius) - (sign * cutterRadius) - (sign * inputs.xySafetyDist)).toFixed(3);
            const preP1 = (inputs.center1 - (sign * finalRadius) - (sign * cutterRadius)).toFixed(3);
            const engageP1 = (inputs.center1 - (sign * finalRadius)).toFixed(3);
            safePoint = `${axes.p1}${safeP1} ${axes.p2}${inputs.center2.toFixed(3)}`;
            preEngagePoint = `${axes.p1}${preP1}`;
            engagePoint = `${axes.p1}${engageP1}`;
          }
        }

        // Program body
        let pg = '';
        pg += `${progNumStr} (${opName})\n`;
        pg += `(TOOL DIA:${inputs.cutterDia.toFixed(3)}  TOOL OFFSET:D${inputs.toolOffset}  FEED:${inputs.feed}mm/min  RPM:${inputs.rpm}  PITCH:${inputs.pitch})\n`;
        pg += `(PLANE: ${inputs.plane}  MILLING: ${inputs.millingType}  MODE: ${inputs.opType === 'id-interpolation' ? 'ID' : 'OD'})\n`;
        pg += `(${new Date().toLocaleString()})\n`;
        pg += `${inputs.plane} G21 G90 G40 G80 G54\n\n`;
        pg += `T${inputs.toolOffset} M6\nS${inputs.rpm} M3\nG43 H${inputs.toolOffset}\nM8\n\n`;

        // Macros if requested
        if (inputs.useDiaMacro) {
          pg += `(--- USER MACROS ---)\n`;
          pg += `#500=${inputs.finalDia.toFixed(3)}(FINAL DIAMETER)\n`;
          pg += `#501=${inputs.cutterDia.toFixed(3)}(CUTTER DIAMETER)\n`;
          pg += `#100=${inputs.center1.toFixed(3)}(CENTER ${axes.p1})\n`;
          pg += `#101=${inputs.center2.toFixed(3)}(CENTER ${axes.p2})\n`;
          pg += `#505=${inputs.xySafetyDist.toFixed(3)}(XY CLEARANCE)\n\n`;
          pg += `(--- CALCULATED MACROS ---)\n`;
          pg += `#502=[#501/2](CUTTER RADIUS)\n`;
          pg += `#503=[#500/2](FINAL PATH RADIUS)\n\n`;
        }

        // Setup machining loop variables (macro friendly)
        // #1 current depth (start at 0), #2 final depth (negative), #3 pitch
        const finalDepthMacroValue = inputs.useDiaMacro ? '#502' : inputs.finalDepth.toFixed(3);
        pg += `(--- HELICAL INTERPOLATION VARIABLES ---)\n`;
        pg += `#1=0 (CURRENT Z)\n`;
        pg += `#2=${inputs.finalDepth.toFixed(3)} (FINAL Z - negative)\n`;
        pg += `#3=${inputs.pitch.toFixed(3)} (PITCH/REV)\n\n`;

        // Approach (safe XY then Z approach)
        pg += `(--- APPROACH ---)\n`;
        if (inputs.opType === 'id-interpolation') {
          // move to center XY then move to safe Z then plunge to clearance above part and engage
          if (inputs.useDiaMacro) {
            pg += `G00 ${axes.p1}#100 ${axes.p2}#101\n`;
          } else {
            pg += `G00 ${axes.p1}${inputs.center1.toFixed(3)} ${axes.p2}${inputs.center2.toFixed(3)}\n`;
          }
          pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n`;
          pg += `G01 ${axes.depth}0.000 F${(inputs.feed * 1.5).toFixed(0)}\n`;
          // Activate cutter compensation and move to engage on p2
          // using G01 G41/G42 D# tool offset with small feed for engage
          pg += `G01 ${inputs.millingType} D${inputs.toolOffset} ${engagePoint} F${(inputs.feed/2).toFixed(0)}\n`;
        } else {
          // OD: move to safe XY outside profile, then approach Z and lead-in
          pg += `G00 ${safePoint}\n`;
          pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n`;
          pg += `G01 ${axes.depth}0.000 F${(inputs.feed * 1.5).toFixed(0)}\n`;
          pg += `G01 ${preEngagePoint} F${inputs.feed}\n`;
          pg += `G01 ${inputs.millingType} D${inputs.toolOffset} ${engagePoint} F${(inputs.feed/2).toFixed(0)}\n`;
        }

        // Helical loop using macro WHILE
        pg += `\n(--- HELICAL DESCENT LOOP ---)\n`;
        pg += `WHILE[#1 GT #2] DO 1\n`;
        pg += `  #1=[#1-#3]\n`;
        pg += `  IF[#1 LT #2] THEN #1=#2\n`;
        // endpoint for circle: for ID uses p2 coordinate (we used engagePoint earlier as p2 or p1 appropriately)
        // We will use the same coordinate (engagePoint) as end point for circular move; depth Z is #1
        const endPoint = inputs.opType === 'id-interpolation' ? `${engagePoint}` : `${engagePoint}`;
        pg += `  ${circleCmd} ${endPoint} ${axes.depth}#1 ${arcVectorString} F${inputs.feed}\n`;
        pg += `END 1\n\n`;

        // Finish pass if selected (single pass at final depth)
        if (inputs.addFinishPass) {
          pg += `(--- FINISH PASS ---)\n`;
          pg += `${circleCmd} ${endPoint} ${arcVectorString} F${Math.max(1, Math.round(inputs.feed/1.5))}\n\n`;
        }

        // Retract & cancel compensation
        pg += `(--- RETRACT ---)\n`;
        pg += `G01 G40 ${safePoint}\n`;
        pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n\n`;
        pg += `M5\nM9\nG28 G91 ${axes.depth}0\nM30\n%`;

        return pg;
      }

      function generateGCode() {
        hideError();
        try {
          const inputs = getInputs();
          const program = buildProgram(inputs);
          gcodeOutput.textContent = program;
          resultsSection.classList.remove('hidden');
          downloadBtn.classList.remove('hidden');
        } catch (err) {
          showError(err.message || String(err));
        }
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.classList.remove('hidden');
        resultsSection.classList.add('hidden');
      }

      function hideError() {
        errorMessage.classList.add('hidden');
      }

      function copyToClipboard() {
        const text = gcodeOutput.textContent;
        if (!text) { showError('No program to copy. Generate first.'); return; }
        navigator.clipboard.writeText(text).then(() => {
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy Code'; }, 1600);
        }).catch((e) => showError('Copy failed: ' + e));
      }

      function downloadGCode() {
        const text = gcodeOutput.textContent;
        if (!text) { showError('No program to download. Generate first.'); return; }
        const progNum = document.getElementById('program-number').value || 'program';
        const filename = `O${progNum}.nc`;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // helper to display error and hide results
      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.classList.remove('hidden');
        resultsSection.classList.add('hidden');
      }

      // initial UI setup
      switchOp('id-interpolation');
      updateLabels();
    });
  </script>
</body>
</html>
