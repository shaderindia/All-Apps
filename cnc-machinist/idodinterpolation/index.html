<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Helical Interpolation G-Code Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .input-group { position: relative; }
        .input-unit { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 0.875rem; }
        .tab-btn { transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out; }
        .tab-btn.active { background-color: #4f46e5; color: white; }
        .tab-btn:not(.active) { background-color: #374151; color: #d1d5db; }
        input:disabled, select:disabled { background-color: #374151; color: #6b7280; cursor: not-allowed; border-color: #4b5563; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700">
        
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-indigo-400">Helical Interpolation Generator (Fanuc)</h1>

        <div class="flex justify-center mb-6 bg-gray-700 rounded-lg p-1">
            <button id="id-interpolation-tab" class="tab-btn w-1/2 py-2 rounded-md text-sm font-semibold active">ID Helical Milling</button>
            <button id="od-interpolation-tab" class="tab-btn w-1/2 py-2 rounded-md text-sm font-semibold">OD Helical Milling</button>
        </div>

        <div id="interpolation-inputs">
            <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-lg">
                    <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Workpiece & Tool Setup</h3></div>
                    <div>
                        <label for="plane-select" class="block text-sm font-medium">Work Plane</label>
                        <select id="plane-select" class="w-full bg-gray-700 rounded-lg p-3 mt-1">
                            <option value="G17">G17 (X-Y)</option>
                            <option value="G18">G18 (X-Z)</option>
                            <option value="G19">G19 (Y-Z)</option>
                        </select>
                    </div>
                     <div>
                        <label for="cutter-diameter" class="block text-sm font-medium">Cutter Diameter</label>
                        <div class="input-group"><input type="number" id="cutter-diameter" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 10"><span class="input-unit">mm</span></div>
                    </div>
                    <div>
                        <label for="program-number" class="block text-sm font-medium">Program Number</label>
                        <div class="input-group"><input type="number" id="program-number" value="1001" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">O####</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-700 rounded-lg">
                    <div class="md:col-span-2"><h3 class="text-lg font-semibold text-gray-300">Feature Geometry</h3></div>
                    <div class="md:col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label id="center1-label" for="center1" class="block text-sm font-medium">Center X</label>
                            <div class="input-group"><input type="number" id="center1" value="0" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
                        </div>
                        <div>
                            <label id="center2-label" for="center2" class="block text-sm font-medium">Center Y</label>
                            <div class="input-group"><input type="number" id="center2" value="0" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
                        </div>
                    </div>
                    <div>
                        <label id="final-diameter-label" for="final-diameter" class="block text-sm font-medium">Final ID Diameter</label>
                        <div class="input-group"><input type="number" id="final-diameter" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 50"><span class="input-unit">mm</span></div>
                    </div>
                    <div class="flex items-end">
                        <div class="flex items-center h-full pb-1">
                             <input type="checkbox" id="use-diameter-macro" class="h-5 w-5 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600">
                             <label for="use-diameter-macro" class="ml-2 text-sm font-medium">Use Macro for Diameter (#500)</label>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-lg">
                     <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Machining Parameters</h3></div>
                    <div>
                        <label id="final-depth-label" for="final-depth" class="block text-sm font-medium">Final Depth (Z)</label>
                        <div class="input-group"><input type="number" id="final-depth" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., -15"><span class="input-unit">mm</span></div>
                    </div>
                    <div>
                        <label for="pitch" class="block text-sm font-medium">Pitch (Depth per Rev)</label>
                        <div class="input-group"><input type="number" id="pitch" class="w-full bg-gray-700 rounded-lg p-3" placeholder="e.g., 1.5"><span class="input-unit">mm</span></div>
                    </div>
                     <div>
                        <label for="safety-distance" class="block text-sm font-medium">Z Safety Distance</label>
                        <div class="input-group"><input type="number" id="safety-distance" value="5" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm</span></div>
                    </div>
                    <div>
                        <label id="xy-safety-dist-label" for="xy-safety-distance" class="block text-sm font-medium">XY Clearance</label>
                        <div class="input-group"><input type="number" id="xy-safety-distance" value="2" class="w-full bg-gray-700 rounded-lg p-3" placeholder="OD only"><span class="input-unit">mm</span></div>
                    </div>
                    <div>
                        <label for="spindle-speed" class="block text-sm font-medium">Spindle Speed</label>
                        <div class="input-group"><input type="number" id="spindle-speed" value="3000" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">RPM</span></div>
                    </div>
                    <div>
                        <label for="feed-rate" class="block text-sm font-medium">Feed Rate</label>
                        <div class="input-group"><input type="number" id="feed-rate" value="500" class="w-full bg-gray-700 rounded-lg p-3"><span class="input-unit">mm/min</span></div>
                    </div>
                    <div class="md:col-span-3 grid grid-cols-2 gap-4">
                        <div>
                            <label for="tool-offset-d" class="block text-sm font-medium">Tool Offset (D & H)</label>
                            <input type="number" id="tool-offset-d" value="1" class="w-full bg-gray-700 rounded-lg p-3">
                        </div>
                        <div>
                            <label for="milling-type" class="block text-sm font-medium">Milling Type</label>
                            <select id="milling-type" class="w-full bg-gray-700 rounded-lg p-3 mt-1">
                                <option value="G41">Climb Milling</option>
                                <option value="G42">Conventional Milling</option>
                            </select>
                        </div>
                    </div>
                     <div class="md:col-span-3 flex items-center pt-2">
                        <input type="checkbox" id="add-finish-pass" class="h-5 w-5 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600" checked>
                        <label for="add-finish-pass" class="ml-2 text-sm font-medium">Add Finish Pass at Final Depth</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="flex mt-6"><button id="generate-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition">Generate G-Code</button></div>
        
        <div id="results-section" class="mt-8 pt-6 border-t border-gray-700 hidden"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold text-indigo-400">Generated Program</h2><button id="copy-btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition text-sm">Copy Code</button></div><pre id="gcode-output" class="bg-gray-900 text-white p-4 rounded-lg text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></pre></div>
        <div id="error-message" class="mt-4 text-center text-red-400 font-medium hidden"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentOperation = 'id-interpolation';
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const resultsSection = document.getElementById('results-section');
            const gcodeOutput = document.getElementById('gcode-output');
            const errorMessage = document.getElementById('error-message');
            const idTab = document.getElementById('id-interpolation-tab');
            const odTab = document.getElementById('od-interpolation-tab');
            const planeSelect = document.getElementById('plane-select');
            const finalDiameterLabel = document.getElementById('final-diameter-label');
            const center1Label = document.getElementById('center1-label');
            const center2Label = document.getElementById('center2-label');
            const finalDepthLabel = document.getElementById('final-depth-label');
            const xySafetyDistLabel = document.getElementById('xy-safety-dist-label');
            
            idTab.addEventListener('click', () => switchOperation('id-interpolation'));
            odTab.addEventListener('click', () => switchOperation('od-interpolation'));
            planeSelect.addEventListener('change', updateUI);
            generateBtn.addEventListener('click', generateGCode);
            copyBtn.addEventListener('click', copyToClipboard);
            
            function switchOperation(op) {
                currentOperation = op;
                idTab.classList.toggle('active', op === 'id-interpolation');
                odTab.classList.toggle('active', op === 'od-interpolation');
                document.getElementById('xy-safety-distance').disabled = (op !== 'od-interpolation');
                updateUI();
                resultsSection.classList.add('hidden');
                hideError();
            }

            function updateUI() {
                const axes = getAxes(planeSelect.value);
                center1Label.textContent = `Center ${axes.p1}`;
                center2Label.textContent = `Center ${axes.p2}`;
                finalDepthLabel.textContent = `Final Depth (${axes.depth})`;
                xySafetyDistLabel.textContent = `${axes.p1}/${axes.p2} Clearance (OD)`;
                finalDiameterLabel.textContent = (currentOperation === 'id-interpolation') ? 'Final ID Diameter' : 'Final OD Diameter';
            }
            
            function generateGCode() {
                hideError();
                try {
                    const inputs = getInterpolationInputs();
                    const axes = getAxes(inputs.plane);
                    const finalRadius = inputs.finalDia / 2;
                    const cutterRadius = inputs.cutterDia / 2;
                    
                    // FIXED: sign determines direction for G41 vs G42
                    // G41 (climb) is the standard direction (+1)
                    // G42 (conventional) reverses the entry and rotation (-1)
                    const sign = inputs.millingType === 'G41' ? 1 : -1;
                    
                    let params = {};
                    if (inputs.useDiaMacro) {
                        const signStr = sign > 0 ? '+' : '-';
                        params = {
                            progNum: inputs.progNum, opName: `${currentOperation.replace('-', ' ').toUpperCase()} (MACRO)`,
                            finalDiaMacro: inputs.finalDia.toFixed(3), cutterDiaMacro: inputs.cutterDia.toFixed(3),
                            center1: '#100', center2: '#101', finalRadius: '#503', cutterRadius: '#502',
                            // FIXED: OD engage/retract points now depend on sign
                            engagePosP1_OD: `[#100${signStr === '+' ? '-' : '+' }#503]`, // G41 engages from left (-), G42 from right (+)
                            preEngagePosP1_OD: `[#100${signStr === '+' ? '-' : '+' }#503${signStr === '+' ? '-' : '+' }#502]`,
                            safePosP1_OD: `[#100${signStr === '+' ? '-' : '+' }#503${signStr === '+' ? '-' : '+' }#502${signStr === '+' ? '-' : '+' }#505]`,
                            // FIXED: ID engage points now depend on sign
                            engagePosP2_ID: `[#101${signStr}#503]`, // G41 engages from +p2, G42 from -p2
                        };
                    } else {
                         params = {
                            progNum: inputs.progNum, opName: `${currentOperation.replace('-', ' ').toUpperCase()}`,
                            center1: inputs.center1.toFixed(3), center2: inputs.center2.toFixed(3),
                            finalRadius: finalRadius.toFixed(3), cutterRadius: cutterRadius.toFixed(3),
                            // FIXED: OD engage/retract points now depend on sign
                            engagePosP1_OD: (inputs.center1 - (sign * finalRadius)).toFixed(3), // G41 engages from left (-), G42 from right (+)
                            preEngagePosP1_OD: (inputs.center1 - (sign * finalRadius) - (sign * cutterRadius)).toFixed(3),
                            safePosP1_OD: (inputs.center1 - (sign * finalRadius) - (sign * cutterRadius) - (sign * inputs.xySafetyDist)).toFixed(3),
                            // FIXED: ID engage points now depend on sign
                            engagePosP2_ID: (inputs.center2 + (sign * finalRadius)).toFixed(3), // G41 engages from +p2, G42 from -p2
                        };
                    }
                    
                    const program = buildProgram(inputs, params, axes);
                    gcodeOutput.textContent = program;
                    resultsSection.classList.remove('hidden');
                } catch (e) {
                    showError(e.message);
                }
            }

            function getAxes(plane) {
                if (plane === 'G18') return { p1: 'X', p2: 'Z', depth: 'Y', arcVec1: 'I', arcVec2: 'K' };
                if (plane === 'G19') return { p1: 'Y', p2: 'Z', depth: 'X', arcVec1: 'J', arcVec2: 'K' };
                return { p1: 'X', p2: 'Y', depth: 'Z', arcVec1: 'I', arcVec2: 'J' };
            }
            
            // FIXED: Arc vectors now correctly flip based on milling type
            function getArcVectors(axes, radiusStr, opType, millingType, useMacro) {
                const sign = millingType === 'G41' ? 1 : -1;
                let vec1 = 0, vec2 = 0;
                let radiusNum = parseFloat(radiusStr);
                
                if (opType === 'id-interpolation') {
                    // G41 (sign=1) starts at +p2, vector to center is -p2.
                    // G42 (sign=-1) starts at -p2, vector to center is +p2.
                    vec2 = -sign * radiusNum;
                } else { // od-interpolation
                    // G41 (sign=1) starts at -p1, vector to center is +p1.
                    // G42 (sign=-1) starts at +p1, vector to center is -p1.
                    vec1 = sign * radiusNum;
                }
                
                let v1Str = vec1.toFixed(3), v2Str = vec2.toFixed(3);
                
                if (useMacro) {
                   if (vec1 !== 0) v1Str = (sign > 0 ? '' : '-') + radiusStr;
                   if (vec2 !== 0) v2Str = (sign > 0 ? '' : '-') + radiusStr;
                   // ID needs special handling as its vector is always negative of its sign
                   if (opType === 'id-interpolation') v2Str = (sign > 0 ? '-' : '') + radiusStr;
                }
                return `${axes.arcVec1}${v1Str} ${axes.arcVec2}${v2Str}`;
            }

             function getInterpolationInputs() {
                const values = {
                    opType: currentOperation, plane: planeSelect.value, progNum: parseInt(document.getElementById('program-number').value),
                    cutterDia: parseFloat(document.getElementById('cutter-diameter').value), toolOffset: parseInt(document.getElementById('tool-offset-d').value),
                    center1: parseFloat(document.getElementById('center1').value), center2: parseFloat(document.getElementById('center2').value),
                    finalDia: parseFloat(document.getElementById('final-diameter').value), finalDepth: parseFloat(document.getElementById('final-depth').value),
                    pitch: parseFloat(document.getElementById('pitch').value), rpm: parseInt(document.getElementById('spindle-speed').value),
                    feed: parseInt(document.getElementById('feed-rate').value), safetyDist: parseFloat(document.getElementById('safety-distance').value),
                    xySafetyDist: parseFloat(document.getElementById('xy-safety-distance').value), useDiaMacro: document.getElementById('use-diameter-macro').checked,
                    addFinishPass: document.getElementById('add-finish-pass').checked, millingType: document.getElementById('milling-type').value
                };
                for (const key in values) { if (key !== 'useDiaMacro' && key !== 'addFinishPass' && key !== 'plane' && key !== 'opType' && key !== 'millingType' && isNaN(values[key])) { throw new Error(`Invalid Input: '${key}' is missing or not a number.`); } }
                if (values.cutterDia <= 0 || values.finalDia <= 0 || values.pitch <= 0) { throw new Error('Diameters and Pitch must be positive values.'); }
                if (values.pitch > (values.cutterDia / 2)) { throw new Error('Safety Error: Pitch should not exceed 50% of Cutter Diameter.'); }
                if (values.opType === 'id-interpolation' && values.cutterDia >= values.finalDia) { throw new Error('For ID milling, Cutter Diameter must be smaller than Final Diameter.'); }
                if (values.finalDepth > 0) values.finalDepth = -values.finalDepth; if (values.pitch < 0) values.pitch = -values.pitch;
                return values;
            }
            
            function buildProgram(inputs, params, axes) {
                const { opType, plane, toolOffset, finalDepth, pitch, rpm, feed, safetyDist, millingType, useDiaMacro, addFinishPass } = inputs;
                
                let circleCmd;
                if (opType === 'id-interpolation') { circleCmd = (millingType === 'G41') ? 'G03' : 'G02'; } 
                else { circleCmd = (millingType === 'G41') ? 'G02' : 'G03'; }
                
                const arcVectorString = getArcVectors(axes, params.finalRadius, opType, millingType, useDiaMacro);
                
                let program = `O${params.progNum} (${params.opName})\n`;
                program += `${plane} G21 G90 G40 G80\n\n`;
                program += `T${toolOffset} M6\nS${rpm} M3\nG43 H${toolOffset} ${axes.depth}${Math.abs(safetyDist) + 50}\nM8\n\n`;
                
                if (useDiaMacro) {
                    program += `(--- USER & GEOMETRY MACROS ---)\n#500=${params.finalDiaMacro}(FINAL DIAMETER)\n#501=${params.cutterDiaMacro}(CUTTER DIAMETER)\n`;
                    program += `#100=${inputs.center1.toFixed(3)}(CENTER ${axes.p1})\n#101=${inputs.center2.toFixed(3)}(CENTER ${axes.p2})\n#505=${inputs.xySafetyDist.toFixed(3)}(OD ${axes.p1}${axes.p2} CLEARANCE)\n\n`;
                    program += `(--- CALCULATED MACROS ---)\n#502=[#501/2](CUTTER RADIUS)\n#503=[#500/2](FINAL/TOOLPATH RADIUS)\n\n`;
                }
                program += `(--- MACHINING VARIABLES ---)\n#1=0(CUR_DEPTH) #2=${finalDepth.toFixed(3)}(FIN_DEPTH) #3=${pitch.toFixed(3)}(PITCH)\n\n`;
                
                if (opType === 'id-interpolation') {
                    program += `(--- ENGAGE ---)\nG00 ${axes.p1}${params.center1} ${axes.p2}${params.center2}\n`;
                    program += `G00 ${axes.depth}${safetyDist.toFixed(3)}\nG01 ${axes.depth}0 F${(feed * 1.5).toFixed(0)}\n`;
                    program += `G01 ${millingType} D${toolOffset} ${axes.p2}${params.engagePosP2_ID} F${(feed / 2).toFixed(0)}\n`;
                } else { // OD-INTERPOLATION
                    program += `(--- ENGAGE ---)\nG00 ${axes.p1}${params.safePosP1_OD} ${axes.p2}${params.center2}\n`;
                    program += `G00 ${axes.depth}${safetyDist.toFixed(3)}\nG01 ${axes.depth}0 F${(feed * 1.5).toFixed(0)}\n`;
                    program += `G01 ${axes.p1}${params.preEngagePosP1_OD} F${feed}\n`;
                    program += `G01 ${millingType} D${toolOffset} ${axes.p1}${params.engagePosP1_OD} F${(feed / 2).toFixed(0)}\n`;
                }

                program += `\n(--- HELICAL INTERPOLATION ---)\nWHILE[#1 GT #2] DO 1\n#1=#1-#3\nIF[#1 LT #2] THEN #1=#2\n`;
                const endPoint = opType === 'id-interpolation' ? `${axes.p2}${params.engagePosP2_ID}` : `${axes.p1}${params.engagePosP1_OD}`;
                program += ` ${circleCmd} ${endPoint} ${axes.depth}#1 ${arcVectorString} F${feed}\nEND 1\n\n`;
                
                if (addFinishPass) {
                    program += `(--- FINISH PASS ---)\n`;
                    program += `${circleCmd} ${endPoint} ${arcVectorString} F${(feed/1.5).toFixed(0)}\n\n`;
                }

                program += `(--- RETRACT ---)\n`;
                if (opType === 'id-interpolation') {
                    program += `G01 G40 ${axes.p2}${params.center2}\n`;
                } else { // OD-INTERPOLATION
                    program += `G01 G40 ${axes.p1}${params.preEngagePosP1_OD}\n`;
                    program += `G00 ${axes.p1}${params.safePosP1_OD}\n`;
                }
                program += `G00 ${axes.depth}${safetyDist.toFixed(3)}\n\nM5\nM9\nG28 G91 ${axes.depth}0\nM30\n%`;
                return program;
            }

            function copyToClipboard() {
                navigator.clipboard.writeText(gcodeOutput.textContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => { copyBtn.textContent = 'Copy Code'; }, 2000);
                }, (err) => { showError('Failed to copy text: ' + err); });
            }
            function showError(message) { errorMessage.textContent = message; errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); }
            function hideError() { errorMessage.classList.add('hidden'); }
            
            switchOperation('id-interpolation');
        });
    </script>
</body>
</html>
