<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Base for your live path -->
  <base href="/cnc-machinist/idodinterpolation/">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ID/OD Helical Interpolation Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .input-group { position: relative; }
    .input-unit { position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 0.875rem; }
    .tab-btn { transition: all 150ms ease-in-out; }
    .tab-btn.active { background-color: #4f46e5; color: white; transform: translateY(-1px); }
    .tab-btn:not(.active) { background-color: #374151; color: #d1d5db; }
    input:disabled, select:disabled { background-color: #374151; color: #6b7280; cursor: not-allowed; border-color: #4b5563; }
    pre { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace; }

    /* Tooltip */
    .tooltip-wrap { position: relative; display: inline-block; }
    .tooltip-bubble {
      position: absolute; inset: auto auto auto 100%; transform: translateX(8px);
      min-width: 260px; max-width: 320px; background: #111827; color: #e5e7eb;
      border: 1px solid #374151; border-radius: 0.5rem; padding: 0.75rem;
      font-size: 0.8rem; line-height: 1.1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.35);
      z-index: 50; display: none;
    }
    .tooltip-wrap.show .tooltip-bubble { display: block; animation: fadeIn 160ms ease-out both; }
    .tooltip-btn {
      user-select: none; display: inline-flex; align-items: center; justify-content: center;
      width: 1.25rem; height: 1.25rem; margin-left: 0.4rem; border-radius: 9999px;
      background: #374151; color: #d1d5db; font-size: 0.8rem; line-height: 1rem; cursor: pointer;
      transition: transform 120ms ease;
    }
    .tooltip-btn:active { transform: scale(0.95); }
    .tooltip-btn:focus { outline: 2px solid #6366f1; outline-offset: 2px; }

    /* Cute micro-animations */
    .card { animation: fadeInUp 220ms ease-out both; }
    @keyframes fadeIn { from {opacity:0; transform: translateY(2px);} to {opacity:1; transform:none;} }
    @keyframes fadeInUp { from {opacity:0; transform: translateY(6px);} to {opacity:1; transform:none;} }
    @keyframes pulseSoft { 0%{transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }
  </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <main class="flex-1 w-full flex items-center justify-center p-4">
    <div class="w-full max-w-2xl bg-gray-800 p-6 sm:p-8 rounded-2xl shadow-2xl border border-gray-700 card">

      <h1 class="text-2xl sm:text-3xl font-bold text-center mb-4 text-indigo-400">ID/OD Helical Interpolation Generator</h1>

      <div class="flex justify-center mb-4 bg-gray-700 rounded-lg p-1">
        <button id="id-interpolation-tab" class="tab-btn w-1/2 py-3 rounded-md text-sm font-semibold active">ID Helical Milling</button>
        <button id="od-interpolation-tab" class="tab-btn w-1/2 py-3 rounded-md text-sm font-semibold">OD Helical Milling</button>
      </div>

      <!-- Live motion preview with direction + mini canvas -->
      <div class="mb-6 p-4 rounded-xl border border-gray-700 bg-gray-900">
        <div class="flex items-center justify-between gap-2 mb-2">
          <div class="text-sm text-gray-400">Motion preview (first circle line at current depth token)</div>
          <div id="dir-badge" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-200">—</div>
        </div>
        <code id="preview-line" class="block text-xs sm:text-sm break-words text-emerald-300 mb-3">—</code>
        <canvas id="preview-canvas" width="260" height="260" class="w-full bg-gray-800 rounded border border-gray-700"></canvas>
      </div>

      <div id="interpolation-inputs" class="space-y-4">
        <!-- Workpiece & Tool Setup -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-xl bg-gray-850">
          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Workpiece & Tool Setup</h3></div>

          <div>
            <label for="plane-select" class="block text-sm font-medium">
              Work Plane
              <span class="tooltip-wrap align-middle" id="plane-tooltip-wrap">
                <button type="button" class="tooltip-btn" id="plane-tooltip-btn" aria-label="Plane legend" title="Plane legend">?</button>
                <div class="tooltip-bubble" id="plane-tooltip">
                  <div class="font-semibold text-indigo-300 mb-1">Plane Legend</div>
                  <ul class="list-disc pl-5 space-y-1">
                    <li><b class="text-indigo-300">G17</b> (X-Y), depth <b>Z</b>, arc center <b>I (X), J (Y)</b></li>
                    <li><b class="text-indigo-300">G18</b> (X-Z), depth <b>Y</b>, arc center <b>I (X), K (Z)</b></li>
                    <li><b class="text-indigo-300">G19</b> (Y-Z), depth <b>X</b>, arc center <b>J (Y), K (Z)</b></li>
                  </ul>
                  <hr class="border-gray-700 my-2">
                  <div class="text-gray-300"><b>Rule:</b> I/J/K sign is the <i>opposite</i> of the engage side.</div>
                </div>
              </span>
            </label>
            <select id="plane-select" class="w-full bg-gray-700 rounded-lg p-4 mt-1">
              <option value="G17">G17 (X-Y)</option>
              <option value="G18">G18 (X-Z)</option>
              <option value="G19">G19 (Y-Z)</option>
            </select>
          </div>

          <div>
            <label for="cutter-diameter" class="block text-sm font-medium">Cutter Diameter</label>
            <div class="input-group">
              <input type="text" id="cutter-diameter" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 10">
              <span class="input-unit">mm</span>
            </div>
          </div>

          <div>
            <label for="program-number" class="block text-sm font-medium">Program Number</label>
            <div class="input-group">
              <input type="text" id="program-number" value="1001" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <span class="input-unit">O####</span>
            </div>
          </div>
        </div>

        <!-- Feature Geometry -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 border border-gray-700 rounded-xl">
          <div class="md:col-span-2"><h3 class="text-lg font-semibold text-gray-300">Feature Geometry</h3></div>
          <div class="md:col-span-2 grid grid-cols-2 gap-4">
            <div>
              <label id="center1-label" for="center1" class="block text-sm font-medium">Center X</label>
              <div class="input-group"><input type="text" id="center1" value="0" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">mm</span></div>
            </div>
            <div>
              <label id="center2-label" for="center2" class="block text-sm font-medium">Center Y</label>
              <div class="input-group"><input type="text" id="center2" value="0" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">mm</span></div>
            </div>
          </div>

          <div>
            <label id="final-diameter-label" for="final-diameter" class="block text-sm font-medium">Final ID Diameter</label>
            <div class="input-group"><input type="text" id="final-diameter" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 50"><span class="input-unit">mm</span></div>
          </div>

          <div class="flex items-end">
            <div class="flex items-center h-full pb-1">
              <input type="checkbox" id="use-diameter-macro" class="h-6 w-6 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600">
              <label for="use-diameter-macro" class="ml-2 text-sm font-medium">Use Macro for Diameter (#500)</label>
            </div>
          </div>
        </div>

        <!-- Machining Parameters -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 rounded-xl">
          <div class="md:col-span-3"><h3 class="text-lg font-semibold text-gray-300">Machining Parameters</h3></div>

          <div>
            <label id="final-depth-label" for="final-depth" class="block text-sm font-medium">Final Depth (Z)</label>
            <div class="input-group"><input type="text" id="final-depth" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., -15"><span class="input-unit">mm</span></div>
          </div>

          <div>
            <label for="pitch" class="block text-sm font-medium">Pitch (Depth/Rev)</label>
            <div class="input-group"><input type="text" id="pitch" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 1.5"><span class="input-unit">mm</span></div>
          </div>

          <div>
            <label for="safety-distance" class="block text-sm font-medium">Z Safety Distance</label>
            <div class="input-group"><input type="text" id="safety-distance" value="5" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">mm</span></div>
          </div>

          <div>
            <label id="xy-safety-dist-label" for="xy-safety-distance" class="block text-sm font-medium">XY Clearance</label>
            <div class="input-group"><input type="text" id="xy-safety-distance" value="2" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">mm</span></div>
          </div>

          <div>
            <label for="spindle-speed" class="block text-sm font-medium">Spindle Speed</label>
            <div class="input-group"><input type="text" id="spindle-speed" value="3000" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">RPM</span></div>
          </div>

          <div>
            <label for="feed-rate" class="block text-sm font-medium">Feed Rate</label>
            <div class="input-group"><input type="text" id="feed-rate" value="500" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500"><span class="input-unit">mm/min</span></div>
          </div>

          <div class="md:col-span-3 grid grid-cols-2 gap-4">
            <div>
              <label for="tool-offset-d" class="block text-sm font-medium">Tool Offset (D & H)</label>
              <input type="text" id="tool-offset-d" value="1" class="w-full bg-gray-700 rounded-lg p-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>

            <div>
              <label for="milling-type" class="block text-sm font-medium">Milling Type</label>
              <select id="milling-type" class="w-full bg-gray-700 rounded-lg p-4 mt-1">
                <option value="G41">Climb (G41)</option>
                <option value="G42">Conventional (G42)</option>
              </select>
            </div>
          </div>

          <div class="md:col-span-3 flex items-center pt-2">
            <input type="checkbox" id="add-finish-pass" class="h-6 w-6 bg-gray-700 border-gray-600 rounded text-indigo-500 focus:ring-indigo-600" checked>
            <label for="add-finish-pass" class="ml-2 text-sm font-medium">Add Finish Pass at Final Depth</label>
          </div>
        </div>
      </div>

      <!-- Normal action buttons -->
      <div class="mt-6 flex flex-col sm:flex-row gap-3">
        <button id="generate-btn" class="flex-1 h-12 bg-indigo-600 hover:bg-indigo-700 active:scale-[0.99] text-white font-bold rounded-lg transition">Generate G-Code</button>
        <button id="download-btn" class="flex-1 h-12 bg-green-600 hover:bg-green-700 active:scale-[0.99] text-white font-bold rounded-lg transition hidden">Download .NC</button>
        <button id="copy-btn" class="sm:w-32 h-12 bg-gray-700 hover:bg-gray-600 active:scale-[0.99] text-white font-semibold rounded-lg transition">Copy</button>
      </div>

      <!-- Results -->
      <div id="results-section" class="mt-6 pt-6 border-t border-gray-700 hidden">
        <h2 class="text-xl font-semibold text-indigo-400 mb-3">Generated G-Code</h2>
        <pre id="gcode-output" class="bg-gray-900 text-white p-4 rounded-lg text-sm whitespace-pre-wrap max-h-96 overflow-y-auto"></pre>
        <div id="error-message" class="mt-4 text-center text-red-400 font-medium hidden"></div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const idTab = document.getElementById('id-interpolation-tab');
      const odTab = document.getElementById('od-interpolation-tab');
      const planeSelect = document.getElementById('plane-select');
      const generateBtn = document.getElementById('generate-btn');
      const downloadBtn = document.getElementById('download-btn');
      const copyBtn = document.getElementById('copy-btn');
      const resultsSection = document.getElementById('results-section');
      const gcodeOutput = document.getElementById('gcode-output');
      const errorMessage = document.getElementById('error-message');
      const previewLine = document.getElementById('preview-line');
      const dirBadge = document.getElementById('dir-badge');
      const canvas = document.getElementById('preview-canvas');
      const ctx = canvas.getContext('2d');

      // Tooltip
      const planeTipWrap = document.getElementById('plane-tooltip-wrap');
      const planeTipBtn  = document.getElementById('plane-tooltip-btn');

      let currentOperation = 'id-interpolation';

      // Tab handlers
      idTab.addEventListener('click', () => { switchOp('id-interpolation'); computePreviewSafe(true); });
      odTab.addEventListener('click', () => { switchOp('od-interpolation'); computePreviewSafe(true); });

      planeSelect.addEventListener('change', () => { updateLabels(); computePreviewSafe(true); });
      generateBtn.addEventListener('click', generateGCode);
      copyBtn.addEventListener('click', copyToClipboard);
      downloadBtn.addEventListener('click', downloadGCode);

      // Inputs reactivity
      document.querySelectorAll('input,select').forEach(el => {
        el.addEventListener('input', () => computePreviewSafe());
        el.addEventListener('change', () => computePreviewSafe());
      });

      // Tooltip behavior
      planeTipBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        planeTipWrap.classList.toggle('show');
      });
      document.addEventListener('click', (e) => {
        if (!planeTipWrap.contains(e.target)) planeTipWrap.classList.remove('show');
      });

      function switchOp(op) {
        currentOperation = op;
        idTab.classList.toggle('active', op === 'id-interpolation');
        odTab.classList.toggle('active', op === 'od-interpolation');
        document.getElementById('xy-safety-distance').disabled = (op !== 'od-interpolation');
        updateLabels();
        resultsSection.classList.add('hidden');
        hideError();
      }

      function updateLabels() {
        const plane = planeSelect.value;
        const axes = getAxes(plane);
        document.getElementById('center1-label').textContent = `Center ${axes.p1}`;
        document.getElementById('center2-label').textContent = `Center ${axes.p2}`;
        document.getElementById('final-diameter-label').textContent = currentOperation === 'id-interpolation' ? `Final ID Diameter` : `Final OD Diameter`;
        document.getElementById('final-depth-label').textContent = `Final Depth (${axes.depth})`;
        document.getElementById('xy-safety-dist-label').textContent = `${axes.p1}/${axes.p2} Clearance (OD)`;
      }

      function getAxes(plane) {
        if (plane === 'G18') return { p1: 'X', p2: 'Z', depth: 'Y', arc1: 'I', arc2: 'K' };
        if (plane === 'G19') return { p1: 'Y', p2: 'Z', depth: 'X', arc1: 'J', arc2: 'K' };
        return { p1: 'X', p2: 'Y', depth: 'Z', arc1: 'I', arc2: 'J' };
      }

      function showError(msg) {
        errorMessage.textContent = msg;
        errorMessage.classList.remove('hidden');
        resultsSection.classList.add('hidden');
      }
      function hideError() { errorMessage.classList.add('hidden'); }

      function getInputs() {
        const data = {
          opType: currentOperation,
          plane: planeSelect.value,
          progNum: parseInt(document.getElementById('program-number').value, 10),
          cutterDia: parseFloat(document.getElementById('cutter-diameter').value),
          center1: parseFloat(document.getElementById('center1').value),
          center2: parseFloat(document.getElementById('center2').value),
          finalDia: parseFloat(document.getElementById('final-diameter').value),
          finalDepth: parseFloat(document.getElementById('final-depth').value),
          pitch: parseFloat(document.getElementById('pitch').value),
          rpm: parseInt(document.getElementById('spindle-speed').value, 10),
          feed: parseFloat(document.getElementById('feed-rate').value),
          safetyDist: parseFloat(document.getElementById('safety-distance').value),
          xySafetyDist: parseFloat(document.getElementById('xy-safety-distance').value),
          useDiaMacro: document.getElementById('use-diameter-macro').checked,
          addFinishPass: document.getElementById('add-finish-pass').checked,
          toolOffset: parseInt(document.getElementById('tool-offset-d').value, 10),
          millingType: document.getElementById('milling-type').value
        };

        const numericKeys = ['progNum','cutterDia','center1','center2','finalDia','finalDepth','pitch','rpm','feed','safetyDist','xySafetyDist','toolOffset'];
        for (const k of numericKeys) {
          if (Number.isNaN(data[k]) || data[k] === null) throw new Error(`Invalid input: ${k} must be a number.`);
        }
        if (data.cutterDia <= 0 || data.finalDia <= 0) throw new Error('Cutter and final diameters must be positive.');
        if (data.pitch <= 0) throw new Error('Pitch must be positive.');
        if (data.opType === 'id-interpolation' && data.cutterDia >= data.finalDia) throw new Error('For ID milling, cutter diameter must be smaller than final diameter.');
        if (data.finalDepth > 0) data.finalDepth = -data.finalDepth; // force negative cut
        if (data.pitch < 0) data.pitch = Math.abs(data.pitch);
        return data;
      }

      // I/J(K) opposite of engage side
      function getArcVectors(axes, radius, mode /* 'id' or 'od' */, millingType, useMacro) {
        const engageSign = (mode === 'id')
          ? (millingType === 'G41' ? +1 : -1)  // ID: G41 engages +p2, G42 engages -p2
          : (millingType === 'G41' ? -1 : +1); // OD: G41 engages -p1, G42 engages +p1
        const arcSign = -engageSign; // opposite of engage

        if (mode === 'id') {
          if (useMacro) {
            const s = arcSign < 0 ? '-' : '';
            return `${axes.arc1}0 ${axes.arc2}${s}${radius}`;
          } else {
            const v2 = arcSign * parseFloat(radius);
            return `${axes.arc1}0.000 ${axes.arc2}${v2.toFixed(3)}`;
          }
        } else {
          if (useMacro) {
            const s = arcSign < 0 ? '-' : '';
            return `${axes.arc1}${s}${radius} ${axes.arc2}0`;
          } else {
            const v1 = arcSign * parseFloat(radius);
            return `${axes.arc1}${v1.toFixed(3)} ${axes.arc2}0.000`;
          }
        }
      }

      function buildProgram(inputs) {
        const axes = getAxes(inputs.plane);
        const sign = inputs.millingType === 'G41' ? 1 : -1;
        const cutterRadius = (inputs.cutterDia / 2);
        const finalRadius = (inputs.finalDia / 2);

        const progNumStr = `O${inputs.progNum}`;
        const opName = (inputs.opType === 'id-interpolation') ? 'ID HELICAL INTERPOLATION' : 'OD HELICAL INTERPOLATION';

        // Circle direction: ID (G41->G03, G42->G02), OD (G41->G02, G42->G03)
        const circleCmd = (inputs.opType === 'id-interpolation')
          ? (inputs.millingType === 'G41' ? 'G03' : 'G02')
          : (inputs.millingType === 'G41' ? 'G02' : 'G03');

        const finalRadiusStr = inputs.useDiaMacro ? '#503' : finalRadius.toFixed(3);
        const arcVectorString = getArcVectors(
          axes,
          finalRadiusStr,
          inputs.opType === 'id-interpolation' ? 'id' : 'od',
          inputs.millingType,
          inputs.useDiaMacro
        );

        // Entry/approach points
        let engagePoint, safePoint;
        if (inputs.useDiaMacro) {
          if (inputs.opType === 'id-interpolation') {
            engagePoint = `${axes.p2}[#101${sign>0?'+':'-'}#503]`;
            safePoint = `${axes.p1}#100 ${axes.p2}#101`;
          } else {
            engagePoint = `${axes.p1}[#100${sign>0?'-':'+'}#503]`;
            safePoint = `${axes.p1}[#100${sign>0?'-':'+'}#503${sign>0?'-':'+'}#502${sign>0?'-':'+'}#505] ${axes.p2}#101`;
          }
        } else {
          if (inputs.opType === 'id-interpolation') {
            const engageP2 = (inputs.center2 + (sign * finalRadius)).toFixed(3);
            engagePoint = `${axes.p2}${engageP2}`;
            safePoint = `${axes.p1}${inputs.center1.toFixed(3)} ${axes.p2}${inputs.center2.toFixed(3)}`;
          } else {
            const engageP1 = (inputs.center1 - (sign * finalRadius)).toFixed(3);
            engagePoint = `${axes.p1}${engageP1}`;
            const safeP1 = (inputs.center1 - (sign * finalRadius) - (sign * cutterRadius) - (sign * inputs.xySafetyDist)).toFixed(3);
            safePoint = `${axes.p1}${safeP1} ${axes.p2}${inputs.center2.toFixed(3)}`;
          }
        }

        // Endpoint includes BOTH axes
        const endPoint = inputs.useDiaMacro
          ? (inputs.opType === 'id-interpolation'
              ? `${axes.p1}#100 ${engagePoint}`
              : `${engagePoint} ${axes.p2}#101`)
          : (inputs.opType === 'id-interpolation'
              ? `${axes.p1}${inputs.center1.toFixed(3)} ${engagePoint}`
              : `${engagePoint} ${axes.p2}${inputs.center2.toFixed(3)}`);

        // Program body (pure Fanuc; no G61/G64; retract via G28 G91 Z0)
        let pg = '';
        pg += `${progNumStr} (${opName})\n`;
        pg += `(TOOL DIA:${inputs.cutterDia.toFixed(3)}  TOOL OFFSET:D${inputs.toolOffset}  FEED:${inputs.feed}mm/min  RPM:${inputs.rpm}  PITCH:${inputs.pitch})\n`;
        pg += `(PLANE: ${inputs.plane}  MILLING: ${inputs.millingType}  MODE: ${inputs.opType === 'id-interpolation' ? 'ID' : 'OD'})\n`;
        pg += `${inputs.plane} G21 G90 G40 G80 G54\n\n`;
        pg += `T${inputs.toolOffset} M6\nS${inputs.rpm} M3\nG43 H${inputs.toolOffset}\nM8\n\n`;

        if (inputs.useDiaMacro) {
          pg += `(--- USER MACROS ---)\n`;
          pg += `#500=${inputs.finalDia.toFixed(3)}(FINAL DIAMETER)\n`;
          pg += `#501=${inputs.cutterDia.toFixed(3)}(CUTTER DIAMETER)\n`;
          pg += `#100=${inputs.center1.toFixed(3)}(CENTER ${axes.p1})\n`;
          pg += `#101=${inputs.center2.toFixed(3)}(CENTER ${axes.p2})\n`;
          pg += `#505=${inputs.xySafetyDist.toFixed(3)}(XY CLEARANCE)\n\n`;
          pg += `(--- CALCULATED MACROS ---)\n`;
          pg += `#502=[#501/2](CUTTER RADIUS)\n`;
          pg += `#503=[#500/2](FINAL PATH RADIUS)\n\n`;
        }

        pg += `(--- HELICAL INTERPOLATION VARIABLES ---)\n`;
        pg += `#1=0 (CURRENT ${axes.depth})\n`;
        pg += `#2=${inputs.finalDepth.toFixed(3)} (FINAL ${axes.depth} - negative)\n`;
        pg += `#3=${inputs.pitch.toFixed(3)} (PITCH/REV)\n\n`;

        // Approach
        pg += `(--- APPROACH ---)\n`;
        if (inputs.opType === 'id-interpolation') {
          pg += `G00 ${axes.p1}${inputs.useDiaMacro ? '#100' : inputs.center1.toFixed(3)} ${axes.p2}${inputs.useDiaMacro ? '#101' : inputs.center2.toFixed(3)}\n`;
          pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n`;
          pg += `G01 ${axes.depth}0.000 F${(inputs.feed * 1.5).toFixed(0)}\n`;
          pg += `G01 ${inputs.millingType} D${inputs.toolOffset} ${engagePoint} F${(inputs.feed/2).toFixed(0)}\n`;
        } else {
          // OD: safe XY -> Z -> engage with comp (no pre-engage linear move)
          pg += `G00 ${safePoint}\n`;
          pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n`;
          pg += `G01 ${axes.depth}0.000 F${(inputs.feed * 1.5).toFixed(0)}\n`;
          pg += `G01 ${inputs.millingType} D${inputs.toolOffset} ${engagePoint} F${(inputs.feed/2).toFixed(0)}\n`;
        }

        // Helical loop
        pg += `\n(--- HELICAL DESCENT LOOP ---)\n`;
        pg += `WHILE[#1 GT #2] DO 1\n`;
        pg += `  #1=[#1-#3]\n`;
        pg += `  IF[#1 LT #2] THEN #1=#2\n`;
        pg += `  ${circleCmd} ${endPoint} ${axes.depth}#1 ${arcVectorString} F${inputs.feed}\n`;
        pg += `END 1\n\n`;

        if (inputs.addFinishPass) {
          pg += `(--- FINISH PASS ---)\n`;
          pg += `${circleCmd} ${endPoint} ${arcVectorString} F${Math.max(1, Math.round(inputs.feed/1.5))}\n\n`;
        }

        // Retract
        pg += `(--- RETRACT ---)\n`;
        pg += `G01 G40 ${safePoint}\n`;
        pg += `G00 ${axes.depth}${inputs.safetyDist.toFixed(3)}\n\n`;
        pg += `M5\nM9\nG28 G91 ${axes.depth}0\nM30\n%`;

        return pg;
      }

      function generateGCode() {
        hideError();
        try {
          const inputs = getInputs();
          const program = buildProgram(inputs);
          gcodeOutput.textContent = program;
          resultsSection.classList.remove('hidden');
          downloadBtn.classList.remove('hidden');

          // Fun micro animation pulse
          resultsSection.style.animation = 'pulseSoft 300ms ease';
          setTimeout(() => resultsSection.style.animation = '', 320);
        } catch (err) {
          showError(err.message || String(err));
        }
      }

      function copyToClipboard() {
        const text = gcodeOutput.textContent;
        if (!text) { showError('No program to copy. Generate first.'); return; }
        navigator.clipboard.writeText(text).then(() => {
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 1400);
        }).catch((e) => showError('Copy failed: ' + e));
      }

      function downloadGCode() {
        const text = gcodeOutput.textContent;
        if (!text) { showError('No program to download. Generate first.'); return; }
        const progNum = document.getElementById('program-number').value || 'program';
        const filename = `O${progNum}.nc`;
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      // ===== Preview (text + direction + mini plot with small sweep animation) =====
      function computePreviewSafe(animated=false) {
        try {
          const inputs = getInputs();
          const axes = getAxes(inputs.plane);
          const sign = inputs.millingType === 'G41' ? 1 : -1;
          const finalRadius = (inputs.finalDia / 2);
          const circleCmd = (inputs.opType === 'id-interpolation')
            ? (inputs.millingType === 'G41' ? 'G03' : 'G02')
            : (inputs.millingType === 'G41' ? 'G02' : 'G03');
          const dirLabel = (circleCmd === 'G03') ? 'CCW <<' : 'CW >>';
          dirBadge.textContent = dirLabel;

          const finalRadiusStr = inputs.useDiaMacro ? '#503' : finalRadius.toFixed(3);
          const arcVectorString = getArcVectors(
            axes,
            finalRadiusStr,
            inputs.opType === 'id-interpolation' ? 'id' : 'od',
            inputs.millingType,
            inputs.useDiaMacro
          );

          let engagePoint;
          if (inputs.useDiaMacro) {
            engagePoint = (inputs.opType === 'id-interpolation')
              ? `${axes.p2}[#101${sign>0?'+':'-'}#503]`
              : `${axes.p1}[#100${sign>0?'-':'+'}#503]`;
          } else {
            engagePoint = (inputs.opType === 'id-interpolation')
              ? `${axes.p2}${(inputs.center2 + (sign * finalRadius)).toFixed(3)}`
              : `${axes.p1}${(inputs.center1 - (sign * finalRadius)).toFixed(3)}`;
          }

          const endPoint = inputs.useDiaMacro
            ? (inputs.opType === 'id-interpolation'
                ? `${axes.p1}#100 ${engagePoint}`
                : `${engagePoint} ${axes.p2}#101`)
            : (inputs.opType === 'id-interpolation'
                ? `${axes.p1}${inputs.center1.toFixed(3)} ${engagePoint}`
                : `${engagePoint} ${axes.p2}${inputs.center2.toFixed(3)}`);

          previewLine.textContent = `${circleCmd} ${endPoint} ${axes.depth}#1 ${arcVectorString} F${inputs.feed}`;

          drawCanvasPreview(inputs, circleCmd, animated);
        } catch (e) {
          previewLine.textContent = '—';
          dirBadge.textContent = '—';
          drawCanvasBlank();
        }
      }

      function drawCanvasBlank() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#1f2937'; // gray-800
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      function drawCanvasPreview(inputs, circleCmd, animated) {
        const centerX = parseFloat(document.getElementById('center1').value) || 0; // p1
        const centerY = parseFloat(document.getElementById('center2').value) || 0; // p2
        const R = (parseFloat(document.getElementById('final-diameter').value) || 0) / 2;
        if (R <= 0) { drawCanvasBlank(); return; }

        const g41 = (inputs.millingType === 'G41');
        const idMode = (inputs.opType === 'id-interpolation');

        // Engage point (schematic in XY)
        let ex = centerX, ey = centerY;
        if (idMode) {
          ey = centerY + (g41 ? +R : -R);
        } else {
          ex = centerX + (g41 ? -R : +R);
        }

        // Transform
        const pad = 20;
        const maxWorld = Math.max(Math.abs(centerX)+R, Math.abs(centerY)+R, 10);
        const scale = Math.min((canvas.width - 2*pad)/(2*maxWorld), (canvas.height - 2*pad)/(2*maxWorld));
        const cx = canvas.width/2 + centerX*scale;
        const cy = canvas.height/2 - centerY*scale;
        const rpx = Math.max(R*scale, 1);

        // Background
        drawCanvasBlank();

        // Crosshair axes
        ctx.strokeStyle = '#374151'; ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(canvas.width, cy); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx, 0); ctx.lineTo(cx, canvas.height); ctx.stroke();

        // Circle base
        ctx.strokeStyle = '#334155'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(cx, cy, rpx, 0, Math.PI*2); ctx.stroke();

        // Engage point
        const exPx = canvas.width/2 + ex*scale;
        const eyPx = canvas.height/2 - ey*scale;
        ctx.fillStyle = '#34d399'; // green
        ctx.beginPath(); ctx.arc(exPx, eyPx, 4, 0, Math.PI*2); ctx.fill();

        // Arc sweep + arrow
        const ccw = (circleCmd === 'G03');
        const theta0 = Math.atan2(ey - centerY, ex - centerX);
        const dtheta = (ccw ? +1 : -1) * (Math.PI/6);
        const theta1 = theta0 + dtheta;

        ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(cx, cy, rpx, -theta0, -theta1, !ccw); // canvas Y inverted
        ctx.stroke();

        // Arrowhead
        const ax = cx + rpx * Math.cos(-theta1);
        const ay = cy + rpx * Math.sin(-theta1);
        const ah = 8;
        const tangentAngle = -theta1 + (ccw ? Math.PI/2 : -Math.PI/2);
        ctx.fillStyle = '#fbbf24';
        ctx.beginPath();
        ctx.moveTo(ax, ay);
        ctx.lineTo(ax - ah*Math.cos(tangentAngle - 0.3), ay - ah*Math.sin(tangentAngle - 0.3));
        ctx.lineTo(ax - ah*Math.cos(tangentAngle + 0.3), ay - ah*Math.sin(tangentAngle + 0.3));
        ctx.closePath();
        ctx.fill();

        // Labels
        ctx.fillStyle = '#9ca3af';
        ctx.font = '11px monospace';
        ctx.fillText(`Center (${centerX.toFixed(3)}, ${centerY.toFixed(3)})`, 8, 14);
        ctx.fillText(`R = ${R.toFixed(3)} mm`, 8, 28);
      }

      // ==== Init ====
      function init() {
        switchOp('id-interpolation');
        updateLabels();
        computePreviewSafe(true);
      }
      init();
    });
  </script>
</body>
</html>
