<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FCJR8H4DME"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'G-FCJR8H4DME');
  </script>
  
  <meta charset="UTF-8">
  <title>Free Online Passport Photo Maker | Create & Print Passport Photos</title>
  <meta name="description" content="Create, crop, and print free passport photos online easily. Our tool provides ultra-smooth cropping and zooming, and perfect formatting for various passport photo requirements.">
  <meta name="keywords" content="passport photo maker, online passport photo, free passport photo, crop passport photo, print passport photo, passport photo online, digital passport photo, passport photo tool, passport photo creator, free passport photo maker, photo cropping tool, passport size photo, passport photo printing">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta name="theme-color" content="#6366f1">

  <!-- FontAwesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Google Fonts (Inter) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />

  <style>
    /* Global Reset & Base Styles */
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(255, 255, 255, 0.5);
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --radius: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --success: #10b981;
      --success-hover: #059669;
    }

    body.dark {
      --primary: #818cf8;
      --primary-hover: #6366f1;
      --bg-gradient: linear-gradient(135deg, #1f2937 0%, #111827 100%);
      --glass-bg: rgba(31, 41, 55, 0.7);
      --glass-border: rgba(255, 255, 255, 0.1);
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
      --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      -webkit-text-size-adjust: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      max-width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text-main);
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Accessibility helpers */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Header */
    .header-glass {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--glass-border);
      padding: clamp(0.75rem, 2vw, 1.5rem) clamp(1rem, 3vw, 2rem);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow);
      flex-wrap: wrap;
      gap: 1rem;
    }

    .header-content {
      flex: 1;
      min-width: 0;
    }

    .header-title {
      font-size: clamp(1.2rem, 4vw, 1.5rem);
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .header-badge {
      background: var(--primary);
      color: white;
      font-size: 0.75rem;
      padding: 0.1rem 0.4rem;
      border-radius: 4px;
      vertical-align: middle;
    }

    .header-sub {
      font-size: clamp(0.8rem, 2vw, 0.875rem);
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .header-nav {
      display: flex;
      gap: 0.5rem;
    }

    .nav-btn {
      background: transparent;
      border: none;
      color: var(--text-main);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: background 0.2s, transform 0.1s;
      min-height: 44px;
      min-width: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .nav-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .nav-btn:active {
      transform: scale(0.95);
    }

    body.dark .nav-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Main Content */
    main {
      flex: 1;
      padding: clamp(1rem, 3vw, 2rem);
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      padding: clamp(1.5rem, 3vw, 2rem);
      margin-bottom: clamp(1.5rem, 3vw, 2rem);
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: clamp(1.1rem, 3vw, 1.25rem);
      margin-bottom: 1.5rem;
      color: var(--primary);
      border-bottom: 1px solid var(--glass-border);
      padding-bottom: 0.5rem;
    }

    h3 {
      font-size: clamp(0.95rem, 2.5vw, 1rem);
      margin-bottom: 1rem;
      color: var(--text-main);
      font-weight: 600;
    }

    /* Upload Area */
    .upload-wrapper {
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .upload-area {
      border: 2px dashed var(--primary);
      border-radius: var(--radius);
      padding: clamp(2rem, 5vw, 3rem) clamp(1rem, 3vw, 2rem);
      text-align: center;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      position: relative;
      width: 100%;
      max-width: 100%;
    }

    .upload-area:hover {
      background: rgba(99, 102, 241, 0.05);
      border-color: var(--primary-hover);
    }

    .upload-area:active {
      transform: scale(0.98);
    }

    .upload-placeholder {
      pointer-events: none;
    }

    .upload-placeholder i {
      color: var(--primary);
      margin-bottom: 1rem;
      font-size: clamp(2rem, 5vw, 3rem);
    }

    .upload-placeholder p {
      font-size: clamp(0.9rem, 2.5vw, 1rem);
    }

    #photo-upload {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }

    /* Editor & Cropper */
    #editor-container {
      margin-top: 1.5rem;
    }

    .editor-toolbar-wrapper {
      padding: 0 0.5rem 1rem;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .editor-toolbar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .color-picker-wrapper {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid var(--glass-border);
      cursor: pointer;
      position: relative;
      transition: transform 0.1s;
    }

    .color-picker-wrapper:active {
      transform: scale(0.9);
    }

    #bg-color-picker {
      width: 150%;
      height: 150%;
      position: absolute;
      top: -25%;
      left: -25%;
      cursor: pointer;
      border: none;
      padding: 0;
    }

    .crop-container {
      max-height: 500px;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    #image-to-crop {
      max-width: 100%;
      display: block;
    }

    /* Processing Overlay */
    .processing-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius);
      z-index: 10;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Download Checkmark Animation */
    @keyframes checkmark-pop {
      0% {
        transform: scale(0) rotate(-180deg);
        opacity: 0;
      }
      50% {
        transform: scale(1.2) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
    }

    .checkmark-animation {
      display: inline-block;
      animation: checkmark-pop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* Upload Pulse Effect */
    @keyframes gentle-pulse {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.02);
        opacity: 0.9;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    .pulse-effect {
      animation: gentle-pulse 1.2s ease-in-out 3; /* 3 pulses */
    }

    .crop-container.pulse-effect {
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }

    /* Split View (Settings & Preview) */
    .split-view {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(1rem, 3vw, 2rem);
    }

    /* Settings Panel */
    .settings-group {
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--glass-border);
    }

    .settings-group:last-child {
      border-bottom: none;
    }

    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .form-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .form-group label {
      font-size: 0.85rem;
      margin-bottom: 0.4rem;
      color: var(--text-muted);
    }

    input[type="number"],
    select {
      background: rgba(255, 255, 255, 0.5);
      border: 1px solid var(--glass-border);
      padding: 0.5rem;
      border-radius: 6px;
      color: var(--text-main);
      font-family: inherit;
      font-size: 16px !important;
      width: 100%;
      min-width: 0;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--primary);
    }

    body.dark input[type="number"],
    body.dark select {
      background: rgba(0, 0, 0, 0.2);
    }

    /* Checkbox/Switch */
    .checkbox-group {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input {
      margin: 0;
      min-width: auto;
    }

    .checkbox-group label {
      margin: 0;
      cursor: pointer;
    }

    /* Buttons */
    .btn-main,
    .btn-secondary {
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      min-height: 44px;
      min-width: 44px;
      font-size: 0.9rem;
    }

    .btn-main {
      background: var(--primary);
      color: white;
    }

    .btn-main:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .btn-main:active {
      transform: translateY(0) scale(0.98);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.8);
      color: var(--text-main);
      border: 1px solid var(--glass-border);
    }

    body.dark .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 1);
    }

    body.dark .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Success button state */
    .btn-success {
      background: var(--success) !important;
      transition: background 0.3s ease;
    }

    .btn-success:hover {
      background: var(--success-hover) !important;
    }

    /* Preview Panel */
    .preview-panel {
      display: flex;
      flex-direction: column;
    }

    .canvas-wrapper {
      background: #e5e7eb;
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      overflow: auto;
      margin-bottom: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 300px;
      padding: 1rem;
      -webkit-overflow-scrolling: touch;
    }

    body.dark .canvas-wrapper {
      background: #374151;
    }

    #output-canvas {
      max-width: 100%;
      max-height: 100%;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .download-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    /* Utilities */
    .hidden {
      display: none !important;
    }

    .text-center {
      text-align: center;
    }

    .mb-8 {
      margin-bottom: clamp(1rem, 3vw, 2rem);
    }

    .text-lg {
      font-size: clamp(1rem, 2.5vw, 1.125rem);
    }

    /* Footer */
    footer {
      text-align: center;
      padding: clamp(1.5rem, 3vw, 2rem);
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
      transition: color 0.2s;
    }

    footer a:hover {
      color: var(--primary-hover);
    }

    .footer-links {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }

    /* Modal */
    .modal-glass {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .modal-glass.active {
      display: flex;
    }

    .modal-content {
      background: var(--glass-bg);
      padding: 2rem;
      border-radius: var(--radius);
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      box-shadow: var(--shadow);
      border: 1px solid var(--glass-border);
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-muted);
      padding: 0.5rem;
      border-radius: 50%;
      min-height: 44px;
      min-width: 44px;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    body.dark .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Mobile Responsive Fixes */
    @media (max-width: 768px) {
      .header-glass {
        flex-direction: column;
        padding: 1rem;
      }
      
      .header-content {
        width: 100%;
        text-align: center;
      }
      
      .header-nav {
        width: 100%;
        justify-content: center;
      }
      
      main {
        padding: 1rem;
      }
      
      .card {
        padding: 1.5rem;
      }
      
      .upload-area {
        padding: 2rem 1rem;
      }
      
      .editor-toolbar {
        justify-content: center;
      }
      
      .form-row {
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .split-view {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .download-actions {
        flex-direction: column;
      }
      
      .download-actions button {
        width: 100%;
      }
      
      footer {
        padding: 1.5rem 1rem;
      }
      
      .footer-links {
        flex-direction: column;
        gap: 0.5rem;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .header-title {
        font-size: 1.1rem;
      }
      
      .upload-area {
        padding: 1.5rem 0.5rem;
      }
      
      .btn-main,
      .btn-secondary {
        font-size: 0.875rem;
        padding: 0.5rem 1rem;
      }
    }

    /* Ensure images are responsive */
    img {
      max-width: 100%;
      height: auto;
    }

    /* Better touch targets */
    button,
    .nav-btn,
    .btn-main,
    .btn-secondary,
    .close-btn {
      min-height: 44px;
      min-width: 44px;
      touch-action: manipulation;
    }

    /* Prevent zoom on iOS */
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    input[type="password"],
    textarea,
    select {
      font-size: 16px !important;
    }

    /* Smooth scrolling */
    @media (prefers-reduced-motion: no-preference) {
      html {
        scroll-behavior: smooth;
      }
    }

    /* Dark mode transition */
    body {
      transition: background 0.3s, color 0.3s;
    }

    /* Focus styles for accessibility */
    button:focus,
    input:focus,
    select:focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --glass-border: rgba(0, 0, 0, 0.8);
      }
    }
  </style>
</head>

<body>
  <header class="header-glass">
    <div class="header-content">
      <h1 class="header-title">
        <i class="fa fa-passport"></i> Passport Photo Maker
        <span class="header-badge">2025</span>
      </h1>
      <div class="header-sub">
        Create, crop, and print passport photos â€” ultra-smooth, mobile friendly, and completely free!
      </div>
    </div>
    <div class="header-nav">
      <button class="nav-btn" id="theme-btn" title="Toggle dark mode" aria-label="Toggle dark mode">
        <i class="fa fa-moon"></i>
      </button>
      <button class="nav-btn" id="info-btn" title="How to use" aria-label="How to use">
        <i class="fa fa-info-circle"></i>
      </button>
    </div>
  </header>

  <main>
    <p class="text-center text-lg mb-8">
      Welcome to our <strong>free online passport photo maker</strong>! Easily <strong>create passport photos</strong>,
      crop, zoom, and format them for various requirements. Download or <strong>print passport photos</strong> with our user-friendly and completely free tool.
    </p>

    <!-- Step 1: Upload & Edit -->
    <section class="card card-glass shadow-lg">
      <h2><i class="fa fa-image"></i> 1. Upload & Edit</h2>

      <div class="upload-wrapper">
        <div class="upload-area" id="upload-area" role="button" tabindex="0" aria-label="Upload photo area">
          <div class="upload-placeholder">
            <i class="fa fa-cloud-upload-alt fa-3x"></i>
            <p>Click or Drag & Drop to Upload Photo</p>
          </div>
        </div>
      </div>
      <input type="file" id="photo-upload" accept="image/*" aria-label="Upload your photo" hidden>

      <div id="editor-container" class="hidden">
        <div class="editor-toolbar-wrapper">
          <div class="editor-toolbar">
            <button class="btn-secondary" id="remove-bg-btn" aria-label="Remove background">
              <i class="fa fa-magic"></i> Remove Background
            </button>
            <div class="color-picker-wrapper" title="Background Color">
              <input type="color" id="bg-color-picker" value="#ffffff" aria-label="Background color picker">
            </div>
            <button class="btn-secondary" id="rotate-left" title="Rotate left" aria-label="Rotate left">
              <i class="fa fa-undo"></i>
            </button>
            <button class="btn-secondary" id="rotate-right" title="Rotate right" aria-label="Rotate right">
              <i class="fa fa-redo"></i>
            </button>
            <button class="btn-secondary" id="reset-crop" title="Reset" aria-label="Reset crop">
              <i class="fa fa-sync"></i>
            </button>
          </div>
        </div>

        <div class="crop-container">
          <img id="image-to-crop" src="" alt="Image to crop">
        </div>

        <div id="bg-processing" class="processing-overlay hidden" aria-hidden="true">
          <div class="spinner"></div>
          <p>Removing Background...</p>
        </div>
      </div>
    </section>

    <!-- Step 2: Settings & Preview -->
    <section class="card card-glass shadow-lg" id="settings-section">
      <h2><i class="fa fa-sliders-h"></i> 2. Settings & Preview</h2>

      <div class="split-view">
        <!-- Controls -->
        <div class="controls-panel">

          <!-- Quick Actions -->
          <div class="settings-group">
            <h3>Quick Actions</h3>
            <div class="btn-group">
              <button class="btn-main" id="autofix-btn" aria-label="Auto-fix layout">
                <i class="fa fa-magic"></i> AutoFix Layout
              </button>
            </div>
          </div>

          <!-- Dimensions -->
          <div class="settings-group">
            <h3>Dimensions</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="unit">Unit</label>
                <select id="unit">
                  <option value="mm">mm</option>
                  <option value="inch">inch</option>
                  <option value="px">px</option>
                </select>
              </div>
              <div class="form-group">
                <label for="dpi">DPI</label>
                <input type="number" id="dpi" value="300" min="72" max="1200" step="1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="photo-width">Width</label>
                <input type="number" id="photo-width" value="35" min="1" step="1">
              </div>
              <div class="form-group">
                <label for="photo-height">Height</label>
                <input type="number" id="photo-height" value="45" min="1" step="1">
              </div>
            </div>
          </div>

          <!-- Layout -->
          <div class="settings-group">
            <h3>Layout</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="page-size">Paper Size</label>
                <select id="page-size">
                  <option value="a4">A4</option>
                  <option value="4r">4R (4"x6")</option>
                  <option value="custom">Custom</option>
                </select>
              </div>
              <div class="form-group">
                <label for="num-photos">Count</label>
                <input type="number" id="num-photos" value="8" min="1" max="100" step="1">
              </div>
            </div>
            <div id="custom-page-size" class="form-row hidden">
              <div class="form-group">
                <label for="custom-width">Custom Width</label>
                <input type="number" id="custom-width" placeholder="W" min="1">
              </div>
              <div class="form-group">
                <label for="custom-height">Custom Height</label>
                <input type="number" id="custom-height" placeholder="H" min="1">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="h-spacing">Gap (H)</label>
                <input type="number" id="h-spacing" value="10" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="v-spacing">Gap (V)</label>
                <input type="number" id="v-spacing" value="10" min="0" step="1">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="margin-top">Margin Top</label>
                <input type="number" id="margin-top" value="10" min="0" step="1">
              </div>
              <div class="form-group">
                <label for="margin-left">Margin Left</label>
                <input type="number" id="margin-left" value="10" min="0" step="1">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group checkbox-group">
                <input type="checkbox" id="autocenter-margin">
                <label for="autocenter-margin">Auto-Center</label>
              </div>
              <div class="form-group checkbox-group">
                <input type="checkbox" id="show-cutlines">
                <label for="show-cutlines">Show Cutlines</label>
              </div>
              <div class="form-group checkbox-group">
                <input type="checkbox" id="add-border">
                <label for="add-border">Add Border</label>
              </div>
            </div>
          </div>

        </div>

        <!-- Live Preview -->
        <div class="preview-panel">
          <h3>Print Preview</h3>
          <div class="canvas-wrapper">
            <canvas id="output-canvas" aria-label="Print preview canvas"></canvas>
          </div>
          <div class="download-actions">
            <div class="form-group">
              <label for="format" class="sr-only">Format</label>
              <select id="format">
                <option value="jpg">JPG</option>
                <option value="png">PNG</option>
              </select>
            </div>
            <button class="btn-main" id="download-btn" aria-label="Download">
              <i class="fa fa-download"></i> Download
            </button>
            <button class="btn-main" id="download-hq-btn" aria-label="High quality download">
              <i class="fa fa-star"></i> HQ Download
            </button>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer>
    <div class="branding">
      <div style="margin-top:0.7em;">
        Credits: Released by <strong>nishikant xalxo</strong> (<a href="https://www.instagram.com/nishix_vamp" target="_blank" rel="noopener noreferrer">@nishix_vamp</a>)
        <br>
        Owner: <b>shaderindia</b> &nbsp;|&nbsp; Release date: <b>26 May 2025</b>
      </div>
      <div class="footer-links mb-2 flex flex-wrap justify-center">
        <a href="./about.html">About</a>
        <a href="./faq.html">FAQ</a>
        <a href="./privacy.html">Privacy Policy</a>
        <a href="./terms.html">Terms and Condition</a>
      </div>
      <p>&copy; 2025 Nishikant Xalxo - Free Apps for You. All rights reserved.</p>
      <p class="mt-2 text-sm">Built with <span class="text-red-500">&hearts;</span> and code.</p>
    </div>
  </footer>

  <!-- Modal for Info/How to Use -->
  <div class="modal-glass" id="info-modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-labelledby="modal-title">
      <button class="close-btn" id="close-info" aria-label="Close">
        <i class="fa fa-times"></i>
      </button>
      <h2 id="modal-title"><i class="fa fa-info-circle"></i> How to Use</h2>
      <ul>
        <li>Upload a clear, straight photo (JPG/PNG).</li>
        <li>Use <b>Remove Background</b> for a professional look.</li>
        <li>Crop the photo to frame the face correctly.</li>
        <li>Adjust settings like size, spacing, and paper type.</li>
        <li>Download and print!</li>
      </ul>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

  <script>
    // PASSPORT PHOTO MAKER - PRODUCTION VERSION
    // Uses Cropper.js for cropping and @imgly/background-removal for AI background removal

    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
      // ==== DOM Elements ====
      const els = {
        uploadArea: document.getElementById('upload-area'),
        photoUpload: document.getElementById('photo-upload'),
        editorContainer: document.getElementById('editor-container'),
        imageToCrop: document.getElementById('image-to-crop'),
        bgProcessing: document.getElementById('bg-processing'),
        removeBgBtn: document.getElementById('remove-bg-btn'),
        bgColorPicker: document.getElementById('bg-color-picker'),
        rotateLeftBtn: document.getElementById('rotate-left'),
        rotateRightBtn: document.getElementById('rotate-right'),
        resetCropBtn: document.getElementById('reset-crop'),
        unit: document.getElementById('unit'),
        dpi: document.getElementById('dpi'),
        photoWidth: document.getElementById('photo-width'),
        photoHeight: document.getElementById('photo-height'),
        pageSize: document.getElementById('page-size'),
        customPageSize: document.getElementById('custom-page-size'),
        customWidth: document.getElementById('custom-width'),
        customHeight: document.getElementById('custom-height'),
        numPhotos: document.getElementById('num-photos'),
        hSpacing: document.getElementById('h-spacing'),
        vSpacing: document.getElementById('v-spacing'),
        marginTop: document.getElementById('margin-top'),
        marginLeft: document.getElementById('margin-left'),
        autocenter: document.getElementById('autocenter-margin'),
        showCutlines: document.getElementById('show-cutlines'),
        addBorder: document.getElementById('add-border'),
        autofixBtn: document.getElementById('autofix-btn'),
        outputCanvas: document.getElementById('output-canvas'),
        format: document.getElementById('format'),
        downloadBtn: document.getElementById('download-btn'),
        downloadHQBtn: document.getElementById('download-hq-btn'),
        themeBtn: document.getElementById('theme-btn'),
        infoBtn: document.getElementById('info-btn'),
        infoModal: document.getElementById('info-modal'),
        closeInfo: document.getElementById('close-info'),
      };

      // ==== State ====
      let cropper = null;
      let originalImageURL = null;
      let currentImageURL = null;
      let currentFile = null;
      let isDark = false;
      let bgColor = '#ffffff';
      let previousUnit = 'mm';

      // ==== Constants ====
      const DISPLAY_DPI = 96; // Standard CSS pixel density for display scaling

      // ==== Validation Helpers ====
      function validateNumber(value, min = 1, max = 10000) {
        const num = parseFloat(value);
        return isFinite(num) && num >= min && num <= max ? num : min;
      }

      // ==== Initialization ====
      function init() {
        // Load saved theme
        isDark = localStorage.getItem('theme') === 'dark';
        if (isDark) {
          document.body.classList.add('dark');
          updateThemeIcon();
        }

        // Set defaults
        if (!els.customWidth.value) els.customWidth.value = 210;
        if (!els.customHeight.value) els.customHeight.value = 297;

        setupEventListeners();
        renderCanvas(); // Initial empty render
      }

      // ==== Event Listeners ====
      function setupEventListeners() {
        // Upload area click
        els.uploadArea.addEventListener('click', () => {
          els.photoUpload.value = '';
          els.photoUpload.click();
        });

        // Keyboard support for upload area
        els.uploadArea.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            els.photoUpload.click();
          }
        });

        // File input change
        els.photoUpload.addEventListener('change', handleFileSelect);

        // Drag & Drop
        els.uploadArea.addEventListener('dragover', (e) => { 
          e.preventDefault(); 
          els.uploadArea.style.background = 'rgba(99,102,241,0.1)'; 
        });
        els.uploadArea.addEventListener('dragleave', (e) => { 
          e.preventDefault(); 
          els.uploadArea.style.background = ''; 
        });
        els.uploadArea.addEventListener('drop', (e) => {
          e.preventDefault();
          els.uploadArea.style.background = '';
          if (e.dataTransfer.files && e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
          }
        });

        // Toolbar buttons
        els.removeBgBtn.addEventListener('click', removeBackground);
        els.bgColorPicker.addEventListener('input', (e) => {
          bgColor = e.target.value;
          renderCanvas();
        });
        els.rotateLeftBtn.addEventListener('click', () => {
          if (cropper) cropper.rotate(-90);
        });
        els.rotateRightBtn.addEventListener('click', () => {
          if (cropper) cropper.rotate(90);
        });
        els.resetCropBtn.addEventListener('click', () => {
          if (cropper) cropper.reset();
        });

        // Settings inputs
        const settingsInputs = [
          els.unit, els.dpi, els.photoWidth, els.photoHeight, els.pageSize,
          els.customWidth, els.customHeight, els.numPhotos,
          els.hSpacing, els.vSpacing, els.marginTop, els.marginLeft,
          els.autocenter, els.showCutlines, els.addBorder, els.format
        ];
        
        settingsInputs.forEach(el => {
          if (el) {
            el.addEventListener('input', handleSettingsChange);
            el.addEventListener('change', handleSettingsChange);
          }
        });

        els.autofixBtn.addEventListener('click', autoFixLayout);

        // Margin inputs disable autocenter
        const disableAutoCenter = () => {
          if (els.autocenter.checked) {
            els.autocenter.checked = false;
            renderCanvas();
          }
        };
        els.marginTop.addEventListener('input', disableAutoCenter);
        els.marginLeft.addEventListener('input', disableAutoCenter);

        // Download buttons
        els.downloadBtn.addEventListener('click', () => downloadOutput(false));
        els.downloadHQBtn.addEventListener('click', () => downloadOutput(true));

        // Theme toggle
        els.themeBtn.addEventListener('click', toggleTheme);

        // Modal controls
        els.infoBtn.addEventListener('click', () => {
          els.infoModal.classList.add('active');
          els.infoModal.setAttribute('aria-hidden', 'false');
        });
        els.closeInfo.addEventListener('click', closeModal);
        els.infoModal.addEventListener('click', (e) => { 
          if (e.target === els.infoModal) closeModal();
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && els.infoModal.classList.contains('active')) {
            closeModal();
          }
        });

        // Orientation change handling
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (cropper) {
              cropper.resize();
              renderCanvas();
            }
          }, 300);
        });

        // Resize handling
        window.addEventListener('resize', () => {
          if (cropper) {
            cropper.resize();
            renderCanvas();
          }
        });
      }

      function handleSettingsChange(e) {
        const el = e.target;
        if (el === els.pageSize) handlePageSizeChange();
        if (el === els.unit) handleUnitChange();
        if (el === els.photoWidth || el === els.photoHeight) updateCropperAspectRatio();
        renderCanvas();
      }

      function closeModal() {
        els.infoModal.classList.remove('active');
        els.infoModal.setAttribute('aria-hidden', 'true');
      }

      // ==== File Handling ====
      function handleFileSelect(e) {
        if (e.target.files && e.target.files[0]) {
          handleFile(e.target.files[0]);
        }
      }

      function handleFile(file) {
        // Validate file type
        if (!file.type.startsWith('image/')) {
          alert('Please upload an image file (JPG/PNG).');
          return;
        }

        // Validate file size (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
          alert('File size must be less than 10MB.');
          return;
        }

        // Clean up previous image URLs to prevent memory leaks
        cleanupImageURLs();

        // Store file and create object URL
        currentFile = file;
        originalImageURL = URL.createObjectURL(file);
        currentImageURL = originalImageURL;

        // Show editor, hide upload area
        els.uploadArea.classList.add('hidden');
        els.editorContainer.classList.remove('hidden');

        // Add pulse effect to crop container
        const cropContainer = document.querySelector('.crop-container');
        if (cropContainer) {
          cropContainer.classList.add('pulse-effect');
          setTimeout(() => {
            cropContainer.classList.remove('pulse-effect');
          }, 3600);
        }

        // Initialize cropper
        startCropper(currentImageURL);
      }

      // ==== Memory Management ====
      function cleanupImageURLs() {
        if (originalImageURL) {
          URL.revokeObjectURL(originalImageURL);
          originalImageURL = null;
        }
        if (currentImageURL && currentImageURL !== originalImageURL) {
          URL.revokeObjectURL(currentImageURL);
          currentImageURL = null;
        }
      }

      // ==== Cropper.js Logic ====
      function startCropper(url) {
        // Destroy previous cropper if exists
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }

        const img = els.imageToCrop;
        img.src = url;
        
        // Handle both cached and new images
        if (img.complete) {
          initializeCropper();
        } else {
          img.onload = initializeCropper;
        }

        img.onerror = function() {
          console.error('Image failed to load');
          alert('Failed to load image. Please try a different file.');
          els.uploadArea.classList.remove('hidden');
          els.editorContainer.classList.add('hidden');
          cleanupImageURLs();
        };

        function initializeCropper() {
          try {
            const aspectRatio = getAspectRatio();
            
            cropper = new Cropper(img, {
              viewMode: 1,
              dragMode: 'move',
              aspectRatio: aspectRatio,
              autoCropArea: 0.8,
              restore: false,
              guides: true,
              center: true,
              highlight: false,
              cropBoxMovable: true,
              cropBoxResizable: true,
              toggleDragModeOnDblclick: false,
              ready: function() {
                renderCanvas();
              },
              cropend: function() {
                renderCanvas();
              }
            });
          } catch (error) {
            console.error('Cropper initialization error:', error);
            alert('Failed to initialize cropper. Please try again.');
          }
        }
      }

      function getAspectRatio() {
        const w = validateNumber(els.photoWidth.value, 1, 1000);
        const h = validateNumber(els.photoHeight.value, 1, 1000);
        return (w > 0 && h > 0) ? w / h : (35 / 45);
      }

      function updateCropperAspectRatio() {
        if (!cropper) return;
        const ratio = getAspectRatio();
        if (ratio && isFinite(ratio)) {
          cropper.setAspectRatio(ratio);
        }
      }

      // ==== Background Removal ====
      async function removeBackground() {
        if (!currentImageURL && !currentFile) return;

        if (!window.crossOriginIsolated) {
          alert('Background removal requires a secure browsing context. This feature may not work on all browsers or hosting environments. Please try using a modern browser or local server.');
          return;
        }

        els.bgProcessing.classList.remove('hidden');
        els.removeBgBtn.disabled = true;

        try {
          const config = {
            publicPath: 'https://cdn.jsdelivr.net/npm/@imgly/background-removal-data@1.0.6/dist/',
            debug: false,
          };

          const { removeBackground: imglyRemoveBackground } = await import('https://cdn.jsdelivr.net/npm/@imgly/background-removal@1.0.5/+esm');

          const source = currentFile || currentImageURL;
          const blob = await imglyRemoveBackground(source, config);
          
          // Clean up previous background-removed URL if it exists
          if (currentImageURL && currentImageURL !== originalImageURL) {
            URL.revokeObjectURL(currentImageURL);
          }
          
          const newUrl = URL.createObjectURL(blob);
          currentImageURL = newUrl;
          
          startCropper(currentImageURL);

        } catch (error) {
          console.error('Background removal failed:', error);
          alert(`Background removal failed: ${error.message || 'Unknown error'}. Please try again.`);
        } finally {
          els.bgProcessing.classList.add('hidden');
          els.removeBgBtn.disabled = false;
        }
      }

      // ==== Rendering Logic ====
      function getDPI() { 
        return validateNumber(els.dpi.value, 72, 1200);
      }

      // Converts a value from the current unit to pixels
      function toPx(val, unit) {
        const dpi = getDPI();
        val = parseFloat(val) || 0;
        if (unit === 'mm') return (val / 25.4) * dpi;
        if (unit === 'inch') return val * dpi;
        return val; // px - DPI has no effect
      }

      // Converts a pixel value to the current unit for display
      function fromPx(px, unit) {
        const dpi = getDPI();
        if (unit === 'mm') return (px * 25.4) / dpi;
        if (unit === 'inch') return px / dpi;
        return px;
      }

      function getDims() {
        const unit = els.unit.value;
        return {
          w: toPx(els.photoWidth.value, unit),
          h: toPx(els.photoHeight.value, unit),
          gapH: toPx(els.hSpacing.value, unit),
          gapV: toPx(els.vSpacing.value, unit),
          marginT: toPx(els.marginTop.value, unit),
          marginL: toPx(els.marginLeft.value, unit)
        };
      }

      function getPageSize() {
        const unit = els.unit.value;
        const type = els.pageSize.value;
        
        if (type === 'a4') return { w: toPx(210, 'mm'), h: toPx(297, 'mm') };
        if (type === '4r') return { w: toPx(4, 'inch'), h: toPx(6, 'inch') };

        return {
          w: toPx(els.customWidth.value, unit),
          h: toPx(els.customHeight.value, unit)
        };
      }

      function renderCanvas() {
        if (!cropper) {
          console.log('Cropper not ready, skipping render');
          return;
        }

        const canvas = els.outputCanvas;
        const ctx = canvas.getContext('2d');
        const dims = getDims();
        const page = getPageSize();
        const count = Math.max(1, parseInt(els.numPhotos.value) || 1);

        // Calculate bitmap size for print quality
        const dpi = getDPI();
        
        canvas.width = Math.round(page.w);
        canvas.height = Math.round(page.h);

        // Normalize DPI for consistent visual display
        const displayScale = DISPLAY_DPI / dpi;
        canvas.style.width = Math.round(page.w * displayScale) + 'px';
        canvas.style.height = Math.round(page.h * displayScale) + 'px';

        // Fill background
        ctx.fillStyle = isDark ? '#23293b' : '#ffffff';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Calculate grid layout
        const contentW = page.w - dims.marginL * 2;
        const contentH = page.h - dims.marginT * 2;

        const cols = Math.floor((contentW + dims.gapH) / (dims.w + dims.gapH)) || 1;
        const rows = Math.ceil(count / cols);

        // Auto-center logic - properly center both horizontally and vertically
        let startX = dims.marginL;
        let startY = dims.marginT;

        if (els.autocenter.checked) {
          const totalRowW = cols * dims.w + (cols - 1) * dims.gapH;
          const totalColH = rows * dims.h + (rows - 1) * dims.gapV;
          
          if (cols > 0) startX = Math.max(0, (page.w - totalRowW) / 2);
          if (rows > 0) startY = Math.max(0, (page.h - totalColH) / 2);
        }

        // Get cropped image
        const croppedCanvas = cropper.getCroppedCanvas({
          width: dims.w * 2,
          height: dims.h * 2,
          imageSmoothingEnabled: true,
          imageSmoothingQuality: 'high',
          fillColor: bgColor
        });

        if (!croppedCanvas) {
          console.log('Cropped canvas is empty');
          return;
        }

        // Draw photos
        let drawn = 0;
        for (let r = 0; r < rows; r++) {
          for (let c = 0; c < cols; c++) {
            if (drawn >= count) break;

            const x = startX + c * (dims.w + dims.gapH);
            const y = startY + r * (dims.h + dims.gapV);

            // Draw image
            ctx.drawImage(croppedCanvas, x, y, dims.w, dims.h);

            // Draw border ONLY if "Add Border" is checked
            if (els.addBorder.checked) {
              ctx.save();
              ctx.strokeStyle = '#000000';
              ctx.lineWidth = 1;
              ctx.strokeRect(x, y, dims.w, dims.h);
              ctx.restore();
            }

            drawn++;
          }
        }

        // Draw grid cutlines in the gaps ONLY (not on photo edges)
        if (els.showCutlines.checked && rows > 0 && cols > 0) {
          ctx.save();
          ctx.lineWidth = 1;
          ctx.strokeStyle = '#999999';
          ctx.setLineDash([2, 2]);

          const hasPhoto = (r, c) => (r * cols + c) < count;

          // Vertical cutlines between columns
          for (let c = 1; c < cols; c++) {
            const x = startX + c * (dims.w + dims.gapH) - dims.gapH / 2;
            for (let r = 0; r < rows; r++) {
              if (hasPhoto(r, c - 1) || hasPhoto(r, c)) {
                const yStart = startY + r * (dims.h + dims.gapV) - dims.gapV / 2;
                const yEnd = yStart + dims.h + dims.gapV;
                ctx.beginPath();
                ctx.moveTo(x, yStart);
                ctx.lineTo(x, yEnd);
                ctx.stroke();
              }
            }
          }

          // Horizontal cutlines between rows
          for (let r = 1; r < rows; r++) {
            const y = startY + r * (dims.h + dims.gapV) - dims.gapV / 2;
            for (let c = 0; c < cols; c++) {
              if (hasPhoto(r - 1, c) || hasPhoto(r, c)) {
                const xStart = startX + c * (dims.w + dims.gapH) - dims.gapH / 2;
                const xEnd = xStart + dims.w + dims.gapH;
                ctx.beginPath();
                ctx.moveTo(xStart, y);
                ctx.lineTo(xEnd, y);
                ctx.stroke();
              }
            }
          }

          ctx.restore();
        }
      }

      // ==== Unit Conversion ====
      // When changing units, the PIXEL VALUE is preserved. Only the displayed number changes.
      function handleUnitChange() {
        const newUnit = els.unit.value;
        if (newUnit === previousUnit) return;

        const dpi = getDPI();
        const inputsToConvert = [
          els.photoWidth, els.photoHeight,
          els.hSpacing, els.vSpacing,
          els.marginTop, els.marginLeft,
          els.customWidth, els.customHeight
        ];

        inputsToConvert.forEach(input => {
          if (!input.value) return;

          let val = parseFloat(input.value);
          let pxVal = 0;

          // Convert from old unit to pixels
          if (previousUnit === 'mm') pxVal = (val / 25.4) * dpi;
          else if (previousUnit === 'inch') pxVal = val * dpi;
          else pxVal = val; // was already in pixels

          // Convert from pixels to new unit
          let newVal = 0;
          if (newUnit === 'mm') newVal = (pxVal * 25.4) / dpi;
          else if (newUnit === 'inch') newVal = pxVal / dpi;
          else newVal = pxVal; // keep as pixels

          input.value = (newUnit === 'px') ? Math.round(newVal) : newVal.toFixed(2);
        });

        previousUnit = newUnit;
        renderCanvas();
      }

      function handlePageSizeChange() {
        const isCustom = els.pageSize.value === 'custom';
        els.customPageSize.classList.toggle('hidden', !isCustom);
        
        // Ensure custom values have defaults if empty
        if (isCustom) {
          if (!els.customWidth.value) els.customWidth.value = 210;
          if (!els.customHeight.value) els.customHeight.value = 297;
        }
        
        renderCanvas();
      }

      // ==== Auto-fix Layout ====
      // Applies 300x400px photo size with 35px gaps/margins
      // Preserves actual pixel values when converting between units
      function autoFixLayout() {
        const currentUnit = els.unit.value;
        const dpi = getDPI();
        const targets = {
          w: 300,  // Target width in pixels
          h: 400,  // Target height in pixels
          gap: 35, // Target gap in pixels
          margin: 35 // Target margin in pixels
        };

        const convert = (pxVal) => {
          if (currentUnit === 'px') return pxVal;
          if (currentUnit === 'inch') return pxVal / dpi;
          if (currentUnit === 'mm') return (pxVal / dpi) * 25.4;
          return pxVal;
        };

        const format = (val) => currentUnit === 'px' ? Math.round(val) : val.toFixed(2);

        els.photoWidth.value = format(convert(targets.w));
        els.photoHeight.value = format(convert(targets.h));
        els.hSpacing.value = format(convert(targets.gap));
        els.vSpacing.value = format(convert(targets.gap));
        els.marginTop.value = format(convert(targets.margin));
        els.marginLeft.value = format(convert(targets.margin));

        // Auto-center is NOT forced by auto-fix anymore
        // It only activates if user manually checks the box

        updateCropperAspectRatio();
        renderCanvas();

        // Visual feedback
        const originalHTML = els.autofixBtn.innerHTML;
        els.autofixBtn.innerHTML = '<i class="fa fa-check"></i> Applied!';
        els.autofixBtn.disabled = true;
        
        setTimeout(() => {
          els.autofixBtn.innerHTML = originalHTML;
          els.autofixBtn.disabled = false;
        }, 1500);
      }

      // ==== Download ====
      function downloadOutput(hq) {
        const ext = els.format.value || 'jpg';
        const mime = ext === 'jpg' ? 'image/jpeg' : 'image/png';
        const quality = hq ? 1.0 : 0.92;
        const filename = `passport-photo-${Date.now()}.${ext}`;

        const btn = hq ? els.downloadHQBtn : els.downloadBtn;
        
        // Store original HTML and disable button
        const originalHTML = btn.innerHTML;
        btn.disabled = true;
        
        // Add checkmark animation
        btn.innerHTML = '<i class="fa fa-check checkmark-animation"></i> Downloaded!';
        btn.classList.add('btn-success');

        els.outputCanvas.toBlob((blob) => {
          if (!blob) {
            alert('Error: Could not generate image. Please try again.');
            // Reset button state on error
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            btn.classList.remove('btn-success');
            return;
          }

          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = filename;
          link.style.display = 'none';
          document.body.appendChild(link);

          link.click();

          // Cleanup
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
          }, 200);

        }, mime, quality);

        // Reset button after animation completes
        setTimeout(() => {
          btn.innerHTML = originalHTML;
          btn.disabled = false;
          btn.classList.remove('btn-success');
        }, 2000);
      }

      // ==== Theme Toggle ====
      function toggleTheme() {
        isDark = !isDark;
        document.body.classList.toggle('dark', isDark);
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateThemeIcon();
        renderCanvas(); // Re-render with dark mode
      }

      function updateThemeIcon() {
        const icon = els.themeBtn.querySelector('i');
        icon.className = isDark ? 'fa fa-sun' : 'fa fa-moon';
      }

      // ==== Global Error Handling ====
      window.addEventListener('error', (e) => {
        console.error('Global error:', e.error);
      });

      window.addEventListener('unhandledrejection', (e) => {
        console.error('Unhandled promise rejection:', e.reason);
      });

      // ==== Cleanup on Page Unload ====
      window.addEventListener('beforeunload', () => {
        cleanupImageURLs();
      });

      // Initialize the app
      init();
    }
  </script>
</body>
</html>
